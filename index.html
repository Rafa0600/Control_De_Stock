<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mikra - Control de Stock</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a2744">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mikra Stock">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #1a2744;
            --bg-card: #243554;
            --bg-input: #1e3a5f;
            --primary: #4facfe;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --purple: #a78bfa;
            --text: #ffffff;
            --text-secondary: #94a3b8;
            --border: #3b5998;
        }
        
        [data-theme="light"] {
            --bg: #e8eaed;
            --bg-card: #ffffff;
            --bg-input: #e9ecef;
            --primary: #1a6dd4;
            --success: #16a34a;
            --warning: #d97706;
            --danger: #dc2626;
            --purple: #7c3aed;
            --text: #111827;
            --text-secondary: #4b5563;
            --border: #9ca3af;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg);
            color: var(--text); 
            min-height: 100vh; 
            padding-bottom: 120px;
        }
        
        [data-theme="light"] .stock-btn.minus { background: #fee2e2; color: #dc2626; border-color: #fca5a5; }
        [data-theme="light"] .stock-btn.plus { background: #dcfce7; color: #16a34a; border-color: #86efac; }
        [data-theme="light"] .stock-btn.zero { background: #fef3c7; color: #d97706; border-color: #fcd34d; }
        [data-theme="light"] .stock-set-btn { background: #dbeafe; color: #2563eb; border-color: #93c5fd; }
        [data-theme="light"] .product-item { box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        [data-theme="light"] .product-item.modified { border-left-color: #8b5cf6; }
        [data-theme="light"] .toast { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        [data-theme="light"] .modal { box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        [data-theme="light"] .bottom-bar { box-shadow: 0 -2px 10px rgba(0,0,0,0.08); }
        
        .header-bar {
            background: var(--bg-card); border-bottom: 1px solid var(--border);
            padding: 8px 12px;
        }
        .header-bar-inner {
            display: flex; justify-content: space-between; align-items: center;
            max-width: 1000px; margin: 0 auto;
        }
        .header-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
        .header-title { font-size: 1em; font-weight: 700; color: var(--primary); white-space: nowrap; }
        .header-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
        
        .sync-inline { display: flex; align-items: center; gap: 5px; font-size: 0.72em; color: var(--text-secondary); min-width: 0; }
        .sync-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--success); flex-shrink: 0; }
        .sync-dot.loading { background: var(--warning); animation: pulse 1s infinite; }
        .sync-dot.error { background: var(--danger); }
        
        .icon-btn {
            width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border);
            background: var(--bg-input); color: var(--text); font-size: 0.95em;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        .icon-btn:active { transform: scale(0.93); }
        
        .offline-bar {
            background: var(--danger); color: white; text-align: center;
            padding: 5px 10px; font-size: 0.72em; font-weight: 600; display: none;
        }
        .offline-bar.show { display: block; }
        .header-bar.error { background: rgba(248, 113, 113, 0.15); border-bottom: 2px solid var(--danger); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 10px; }
        
        .search-container { position: relative; margin-bottom: 10px; }
        .search-box {
            background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px;
            padding: 12px 16px; display: flex; align-items: center; gap: 10px;
        }
        .search-box input {
            flex: 1; background: none; border: none; color: var(--text); font-size: 15px; outline: none;
        }
        .search-box input::placeholder { color: var(--text-secondary); }
        
        .search-clear {
            background: var(--danger); border: none; color: white; font-size: 0.9em;
            cursor: pointer; padding: 8px 14px; border-radius: 8px; font-weight: 700; display: none;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 36px;
        }
        .search-clear.show { display: block; }
        
        .autocomplete {
            position: absolute; top: 100%; left: 0; right: 0;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 0 0 12px 12px; max-height: 300px; overflow-y: auto; z-index: 100; display: none;
        }
        .autocomplete.show { display: block; }
        .autocomplete-item {
            padding: 14px 16px; cursor: pointer; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            min-height: 48px; -webkit-tap-highlight-color: transparent;
        }
        .autocomplete-item:hover { background: var(--bg-input); }
        .autocomplete-name { font-weight: 600; }
        .autocomplete-stock { 
            font-size: 0.8em; color: var(--success);
            background: rgba(74, 222, 128, 0.2); padding: 2px 8px; border-radius: 10px;
        }
        
        .filter-row { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
        @media (max-width: 640px) {
            .filter-row { 
                flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch;
                padding-bottom: 6px; scrollbar-width: none; -ms-overflow-style: none;
            }
            .filter-row::-webkit-scrollbar { display: none; }
        }
        .filter-chip {
            padding: 8px 14px; background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 20px; font-size: 0.75em; font-weight: 600; color: var(--text-secondary); cursor: pointer;
            white-space: nowrap; flex-shrink: 0; min-height: 36px;
            display: flex; align-items: center; justify-content: center;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        .filter-chip:hover { border-color: var(--primary); color: var(--primary); }
        .filter-chip.active { background: var(--primary); border-color: var(--primary); color: white; }
        .filter-chip.stock.active { background: var(--success); border-color: var(--success); }
        .filter-chip.low.active { background: var(--warning); border-color: var(--warning); color: #1a2744; }
        .filter-chip.out.active { background: var(--danger); border-color: var(--danger); }
        .filter-chip.critical.active { background: var(--purple); border-color: var(--purple); }
        .filter-chip.modified-chip { border-color: var(--purple); color: var(--purple); }
        .filter-chip.modified-chip.active { background: var(--purple); border-color: var(--purple); color: white; }
        
        .filters-collapse {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 10px; margin-bottom: 10px; overflow: hidden;
        }
        .filters-header {
            padding: 12px 16px; display: flex; justify-content: space-between;
            align-items: center; cursor: pointer; font-size: 0.85em; font-weight: 600;
        }
        .filters-header:hover { background: var(--bg-input); }
        .filters-arrow { transition: transform 0.3s; }
        .filters-collapse.open .filters-arrow { transform: rotate(180deg); }
        .filters-body { display: none; padding: 0 16px 16px; }
        .filters-collapse.open .filters-body { display: block; }
        .filter-section-title { font-size: 0.7em; color: var(--text-secondary); margin: 12px 0 8px; text-transform: uppercase; }
        .filter-options { display: flex; flex-wrap: wrap; gap: 6px; }
        .filter-opt {
            padding: 5px 12px; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 6px; font-size: 0.75em; color: var(--text-secondary); cursor: pointer;
        }
        .filter-opt:hover { border-color: var(--primary); color: var(--primary); }
        .filter-opt.active { background: var(--primary); border-color: var(--primary); color: white; }
        /* Color sin stock: tachado, sin badge */
        .filter-opt.no-stock-color { 
            opacity: 0.45; text-decoration: line-through; text-decoration-color: var(--danger);
        }
        .filter-opt.active.no-stock-color { opacity: 0.8; }
        
        /* Bot√≥n multi-select */
        .multi-toggle {
            padding: 4px 10px; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 6px; font-size: 0.7em; color: var(--text-secondary); cursor: pointer;
            margin-left: auto;
        }
        .multi-toggle:hover { border-color: var(--primary); color: var(--primary); }
        .multi-toggle.active { background: var(--purple); border-color: var(--purple); color: white; }
        
        /* Bot√≥n limpiar filtros */
        .clear-filters-btn {
            padding: 4px 10px; background: var(--danger); border: none;
            border-radius: 6px; font-size: 0.7em; color: white; cursor: pointer;
            font-weight: 600; display: none;
        }
        .clear-filters-btn.show { display: inline-block; }
        
        /* FOTOS */
        .product-thumb {
            width: 40px; height: 40px; border-radius: 6px; object-fit: cover;
            background: var(--bg-input); cursor: pointer; flex-shrink: 0;
            border: 1px solid var(--border); display: none;
        }
        .show-images .product-thumb { display: block; }
        .product-thumb-placeholder {
            width: 40px; height: 40px; border-radius: 6px; background: var(--bg-input);
            display: none; align-items: center; justify-content: center; font-size: 1em;
            flex-shrink: 0; border: 1px solid var(--border);
        }
        .show-images .product-thumb-placeholder { display: flex; }
        .img-modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            z-index: 400; align-items: center; justify-content: center; padding: 20px;
        }
        .img-modal-overlay.show { display: flex; }
        .img-modal-overlay img { max-width: 90vw; max-height: 80vh; border-radius: 12px; object-fit: contain; }
        .img-modal-close {
            position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2);
            border: none; color: white; font-size: 1.5em; width: 40px; height: 40px;
            border-radius: 50%; cursor: pointer;
        }
        .active-filters { display: flex; gap: 6px; margin-left: 10px; }
        .active-filter-tag { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; }
        
        /* GALER√çA DE COLORES POR IMAGEN */
        .color-gallery-btn {
            padding: 4px 10px; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 6px; font-size: 0.7em; color: var(--text-secondary); cursor: pointer;
        }
        .color-gallery-btn:hover { border-color: var(--primary); color: var(--primary); }
        
        .color-gallery-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92);
            z-index: 500; flex-direction: column;
        }
        .color-gallery-overlay.show { display: flex; }
        
        .color-gallery-header {
            padding: 14px 16px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); flex-shrink: 0;
        }
        .color-gallery-title { font-weight: 700; font-size: 1em; color: var(--primary); }
        .color-gallery-close {
            background: rgba(255,255,255,0.15); border: none; color: white;
            font-size: 1.3em; width: 44px; height: 44px; border-radius: 50%; cursor: pointer;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        
        .color-gallery-grid {
            flex: 1; overflow-y: auto; padding: 10px;
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 8px; align-content: start;
            -webkit-overflow-scrolling: touch;
        }
        @media (min-width: 600px) {
            .color-gallery-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding: 12px; }
        }
        
        .color-gallery-item {
            background: var(--bg-card); border: 2px solid var(--border); border-radius: 10px;
            overflow: hidden; cursor: pointer; transition: all 0.2s;
        }
        .color-gallery-item:hover { border-color: var(--primary); transform: scale(1.03); }
        .color-gallery-item.active { border-color: var(--primary); box-shadow: 0 0 12px rgba(79,172,254,0.4); }
        .color-gallery-item.no-stock-gallery { opacity: 0.4; }
        
        .color-gallery-img {
            width: 100%; aspect-ratio: 1; object-fit: cover; background: var(--bg-input);
            display: block;
        }
        .color-gallery-img-placeholder {
            width: 100%; aspect-ratio: 1; background: var(--bg-input);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5em; color: var(--text-secondary);
        }
        .color-gallery-label {
            padding: 8px; text-align: center; font-size: 0.75em; font-weight: 600;
            color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .color-gallery-stock {
            font-size: 0.65em; color: var(--text-secondary); display: block; margin-top: 2px;
        }
        .color-gallery-stock.out { color: var(--danger); }
        
        .results-info { font-size: 0.8em; color: var(--text-secondary); padding: 8px 0; }
        .results-info strong { color: var(--primary); }
        
        .product-list { display: flex; flex-direction: column; gap: 1px; background: var(--border); border-radius: 10px; overflow: hidden; }
        
        .color-divider {
            background: var(--bg); padding: 8px 16px; font-size: 0.75em; font-weight: 700;
            color: var(--primary); border-bottom: 2px solid var(--primary);
            text-transform: uppercase; letter-spacing: 1px;
        }
        
        .product-item {
            background: var(--bg-card); padding: 14px 16px;
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        .product-item:hover { background: var(--bg-input); }
        .product-item.modified { background: rgba(167, 139, 250, 0.15); border-left: 3px solid var(--purple); }
        .product-item.no-stock { opacity: 0.7; }
        
        .product-info { flex: 1; min-width: 0; cursor: pointer; }
        .product-name { font-weight: 500; font-size: 0.75em; margin-bottom: 4px; color: var(--text-secondary); }
        .product-meta { font-size: 1.1em; color: var(--text); font-weight: 700; margin-bottom: 3px; }
        .product-sku { font-size: 0.85em; color: var(--primary); opacity: 1; font-weight: 600; }
        
        .product-right { display: flex; align-items: center; gap: 12px; }
        
        .product-stock { text-align: center; min-width: 70px; }
        .stock-num { font-size: 1.5em; font-weight: 800; line-height: 1; }
        .stock-num.high { color: var(--success); }
        .stock-num.med { color: var(--warning); }
        .stock-num.low { color: var(--danger); }
        .stock-label { font-size: 0.65em; color: var(--text-secondary); margin-top: 2px; text-transform: uppercase; }
        .stock-original { font-size: 0.7em; color: var(--text-secondary); margin-top: 2px; }
        .stock-modified { font-size: 0.7em; color: var(--purple); margin-top: 2px; font-weight: 700; }
        
        /* CONTROLES DE STOCK */
        .stock-controls {
            display: flex; gap: 4px; align-items: center; flex-wrap: wrap;
        }
        
        .stock-input-group {
            display: flex; gap: 4px; align-items: center;
            background: var(--bg-input); border-radius: 8px; padding: 4px;
        }
        
        .stock-manual-input {
            width: 50px; background: var(--bg); border: 1px solid var(--border);
            color: var(--text); padding: 8px 6px; border-radius: 6px;
            font-size: 0.9em; font-weight: 700; text-align: center;
            outline: none;
        }
        
        .stock-manual-input:focus {
            border-color: var(--primary);
        }
        
        .stock-set-btn {
            background: var(--primary); border: none; color: white;
            padding: 8px 12px; border-radius: 6px; font-size: 0.8em;
            font-weight: 700; cursor: pointer;
        }
        .stock-set-btn:hover { background: #3a8cd9; }
        
        .stock-btn {
            width: 40px; height: 40px; border-radius: 8px;
            font-size: 1.2em; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; border: none;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        
        .stock-btn:active { transform: scale(0.95); }
        
        .stock-btn.minus { 
            background: #fbbf24; color: #1a2744;
        }
        .stock-btn.minus:hover { 
            background: #f59e0b; 
        }
        
        .stock-btn.plus { 
            background: #4ade80; color: #1a2744;
        }
        .stock-btn.plus:hover { 
            background: #22c55e; 
        }
        
        .stock-btn.zero { 
            background: #f87171; color: white;
        }
        .stock-btn.zero:hover { 
            background: #ef4444; 
        }
        
        /* ============ MOBILE LAYOUT ============ */
        .mobile-edit-btn {
            display: none;
            width: 44px; height: 44px; border-radius: 8px;
            background: var(--bg-input); border: 1px solid var(--border);
            color: var(--text-secondary); font-size: 1.1em; cursor: pointer;
            align-items: center; justify-content: center;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
            flex-shrink: 0;
        }
        .mobile-edit-btn:hover { background: var(--primary); border-color: var(--primary); color: white; }
        .mobile-edit-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        
        .stock-controls-panel {
            display: none;
            padding: 12px 16px 14px;
            background: rgba(79, 172, 254, 0.08);
            border-top: 1px solid var(--border);
            gap: 10px;
            align-items: center;
            justify-content: center;
            animation: slideDown 0.2s ease;
        }
        .stock-controls-panel.show { display: flex; }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stock-controls-panel .stock-btn {
            width: 48px; height: 48px; font-size: 1.4em;
        }
        
        .stock-controls-panel .stock-input-group {
            padding: 6px; border-radius: 10px;
        }
        
        .stock-controls-panel .stock-manual-input {
            width: 60px; padding: 10px 8px; font-size: 1em;
        }
        
        .stock-controls-panel .stock-set-btn {
            padding: 10px 16px; font-size: 0.9em;
        }
        
        @media (max-width: 640px) {
            body { padding-bottom: 130px; }
            .container { padding: 8px; }
            .header { padding: 10px 12px; }
            .header-title { font-size: 1em; }
            
            /* Search */
            .search-box { padding: 10px 14px; }
            .search-box input { font-size: 16px; } /* Prevents iOS zoom */
            
            /* Product cards */
            .product-item {
                padding: 12px; gap: 8px;
                flex-wrap: wrap;
            }
            .mobile-edit-btn {
                display: flex;
                min-width: 44px; min-height: 44px;
                width: 44px; height: 44px;
            }
            /* Hide inline controls on mobile */
            .stock-controls {
                display: none !important;
            }
            /* Compact product info */
            .product-meta { font-size: 1em; }
            .product-name { font-size: 0.72em; }
            .product-sku { font-size: 0.8em; }
            .stock-num { font-size: 1.3em; }
            .product-stock { min-width: 55px; }
            
            /* Color divider */
            .color-divider { padding: 6px 12px; font-size: 0.72em; }
            
            /* Thumbnails */
            .product-thumb { width: 36px; height: 36px; }
            .product-thumb-placeholder { width: 36px; height: 36px; font-size: 0.9em; }
            
            /* Stock buttons in mobile panel - bigger touch targets */
            .stock-controls-panel .stock-btn {
                width: 52px; height: 52px; font-size: 1.5em; border-radius: 10px;
            }
            .stock-controls-panel .stock-manual-input {
                width: 65px; padding: 12px 8px; font-size: 16px; /* Prevent iOS zoom */
            }
            .stock-controls-panel .stock-set-btn {
                padding: 12px 18px; font-size: 1em;
            }
            
            /* Filter options */
            .filter-opt { padding: 8px 14px; font-size: 0.8em; min-height: 36px;
                display: flex; align-items: center; }
            .filter-section-title { font-size: 0.72em; margin: 10px 0 6px; }
            .filters-header { padding: 14px 16px; font-size: 0.9em; min-height: 48px; }
            
            /* Bottom bar */
            .action-buttons { gap: 4px; }
            .action-btn { padding: 8px 6px; font-size: 0.7em; min-height: 32px; }
            .modifications-summary { margin-bottom: 2px; }
            
            /* Modal */
            .modal { max-height: 92vh; border-radius: 14px 14px 0 0; margin-top: auto; }
            .modal-header { padding: 14px 16px; }
            .modal-body { padding: 16px 26px 16px 16px; -webkit-overflow-scrolling: touch; padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px)); }
            .modal-close { width: 40px; height: 40px; font-size: 1.6em; }
            
            /* Autocomplete */
            .autocomplete-item { padding: 14px 16px; min-height: 48px; }
            
            /* Header bar compact */
            .header-bar { padding: 6px 10px; }
            .header-title { font-size: 0.9em; }
            .icon-btn { width: 34px; height: 34px; font-size: 0.85em; }
            
            /* Toast */
            .toast { top: 8px; font-size: 0.75em; padding: 5px 14px; }
            
            /* Results info */
            .results-info { font-size: 0.75em; padding: 6px 4px; }
            
            /* Pagination */
            .page-btn { padding: 10px 14px; min-width: 44px; min-height: 44px; }
            
            /* Settings & WhatsApp modal inputs */
            .modal-body input[type="number"] { font-size: 16px; } /* Prevent iOS zoom */
            
            /* Image modal */
            .img-modal-overlay img { max-width: 95vw; max-height: 85vh; }
            .img-modal-close { top: 10px; right: 10px; width: 44px; height: 44px; }
        }
        
        /* Extra small screens (iPhone SE, etc) */
        @media (max-width: 375px) {
            .container { padding: 6px; }
            .product-item { padding: 10px 8px; }
            .product-meta { font-size: 0.95em; }
            .action-btn { font-size: 0.75em; padding: 12px 6px; min-width: 60px; }
            .filter-chip { padding: 7px 10px; font-size: 0.7em; }
        }
        
        .pagination {
            display: flex; justify-content: center; gap: 6px; margin-top: 12px; flex-wrap: wrap;
        }
        .page-btn {
            background: var(--bg-card); border: 1px solid var(--border); color: var(--text);
            padding: 10px 14px; border-radius: 8px; font-size: 0.85em; cursor: pointer;
            min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        .page-btn:hover:not(:disabled) { background: var(--bg-input); border-color: var(--primary); }
        .page-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .empty { 
            padding: 60px 20px; text-align: center; color: var(--text-secondary); 
        }
        .empty-icon { font-size: 3em; margin-bottom: 12px; opacity: 0.5; }
        
        .toast {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            background: var(--bg-card); color: var(--text); padding: 8px 18px;
            border-radius: 20px; font-size: 0.82em; font-weight: 600;
            z-index: 1000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; border: 1px solid var(--border);
            white-space: nowrap; max-width: 85vw; text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .toast.show { opacity: 1; pointer-events: auto; }
        .toast.success { background: var(--success); color: #1a2744; }
        .toast.warning { background: var(--warning); color: #1a2744; }
        .toast.error { background: var(--danger); color: white; }
        .undo-btn {
            background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.4);
            color: inherit; padding: 4px 10px; border-radius: 6px; font-size: 0.85em;
            font-weight: 700; cursor: pointer; margin-left: 10px; vertical-align: middle;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        .undo-btn:active { background: rgba(255,255,255,0.4); }
        
        /* BARRA INFERIOR */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-card); border-top: 1px solid var(--border);
            padding: 5px 10px calc(5px + env(safe-area-inset-bottom, 0px)); z-index: 100;
        }
        .bottom-bar-inner {
            max-width: 1000px; margin: 0 auto;
        }
        
        .modifications-summary {
            text-align: center; margin-bottom: 3px; font-size: 0.7em;
        }
        
        .mod-count { color: var(--text-secondary); }
        .mod-count strong { color: var(--purple); font-size: 1.2em; }
        
        .action-buttons {
            display: flex; gap: 5px; justify-content: center;
        }
        
        .action-btn {
            flex: 1; min-width: 70px; padding: 7px 8px;
            border: none; border-radius: 8px; font-weight: 700;
            font-size: 0.72em; cursor: pointer; transition: all 0.2s;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        
        .action-btn:disabled {
            opacity: 0.4; cursor: not-allowed;
        }
        
        .action-btn.view {
            background: var(--primary); color: white;
        }
        .action-btn.view:hover:not(:disabled) { background: #3a8cd9; }
        
        .action-btn.copy {
            background: var(--success); color: #1a2744;
        }
        .action-btn.copy:hover:not(:disabled) { background: #3cbd6b; }
        
        .action-btn.clear {
            background: var(--danger); color: white;
        }
        .action-btn.clear:hover:not(:disabled) { background: #e65e5e; }
        
        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85); z-index: 200;
            display: flex; align-items: center; justify-content: center;
            padding: 20px 20px 70px; opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        @media (max-width: 640px) {
            .modal-overlay { align-items: flex-end; padding: 0; }
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        body.modal-open { overflow: hidden; }
        body.modal-open .container,
        body.modal-open .header-bar,
        body.modal-open .bottom-bar { visibility: hidden; }
        
        .modal {
            background: var(--bg-card); border-radius: 16px;
            max-width: 600px; width: 100%; max-height: 85vh;
            display: flex; flex-direction: column; border: 1px solid var(--border);
            overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.5);
        }
        
        .modal-header {
            padding: 16px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        
        .modal-title { font-weight: 700; font-size: 1.1em; }
        
        .modal-close {
            background: none; border: none; color: var(--text);
            font-size: 1.5em; cursor: pointer; padding: 0;
            width: 30px; height: 30px; display: flex; align-items: center;
            justify-content: center; border-radius: 6px;
        }
        .modal-close:hover { background: var(--bg-input); }
        
        .modal-body {
            padding: 20px 40px 20px 20px; overflow-y: auto; flex: 1; min-height: 0;
            scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.25) transparent;
        }
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: transparent; margin: 8px 0; }
        .modal-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.25); border-radius: 3px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }
        [data-theme="light"] .modal-body { scrollbar-color: rgba(0,0,0,0.2) transparent; }
        [data-theme="light"] .modal-body::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); }
        [data-theme="light"] .modal-body::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.35); }
        
        .mod-item {
            background: var(--bg-input); padding: 12px; border-radius: 8px;
            margin-bottom: 8px; border-left: 3px solid var(--purple);
        }
        
        .mod-item-header {
            font-weight: 700; margin-bottom: 4px;
        }
        
        .mod-item-detail {
            font-size: 0.85em; color: var(--text-secondary); margin-bottom: 2px;
        }
        
        .mod-item-change {
            margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9em;
        }
        
        .mod-old { color: var(--danger); text-decoration: line-through; }
        .mod-new { color: var(--success); font-weight: 700; font-size: 1.2em; }
        
        /* PANTALLA DE CARGA */
        .loading-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg); z-index: 300;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; transition: opacity 0.3s;
        }
        .loading-screen.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { font-size: 3em; margin-bottom: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: var(--text-secondary); font-size: 0.9em; }
        .loading-error { 
            color: var(--danger); margin-top: 20px; padding: 16px; 
            background: rgba(248, 113, 113, 0.1); border-radius: 8px;
            max-width: 400px; text-align: center; font-size: 0.85em;
            display: none;
        }
        
        .whatsapp-preview {
            background: var(--bg); border-radius: 8px; padding: 12px;
            font-family: monospace; font-size: 0.8em; white-space: pre-wrap;
            margin-top: 12px; border: 1px solid var(--border);
            max-height: 300px; overflow-y: auto;
        }
        
        /* SETTINGS PANEL */
        .settings-section { margin-bottom: 20px; }
        .settings-section-title {
            font-size: 0.7em; font-weight: 700; text-transform: uppercase;
            color: var(--text-secondary); letter-spacing: 0.5px; margin-bottom: 10px;
            padding-bottom: 6px; border-bottom: 1px solid var(--border);
        }
        .setting-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .setting-row:last-child { border-bottom: none; }
        .setting-label { font-size: 0.9em; font-weight: 600; }
        .setting-desc { font-size: 0.72em; color: var(--text-secondary); margin-top: 2px; }
        .setting-control { flex-shrink: 0; margin-left: 12px; }
        
        /* Toggle switch */

        /* === ARTICLE MATRIX VIEW === */
        .matrix-article-name { font-size: 1.15em; font-weight: 800; margin-bottom: 8px; }
        .matrix-stats { display: flex; gap: 12px; font-size: 0.75em; color: var(--text-secondary); margin-bottom: 14px; }
        .matrix-color-section { margin-bottom: 16px; }
        .matrix-color-title { font-size: 0.85em; font-weight: 700; margin-bottom: 6px; padding: 4px 10px; background: var(--bg-input); border-radius: 6px; display: inline-block; }
        .matrix-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
        .matrix-cell {
            width: 58px; text-align: center; padding: 6px 2px; border-radius: 8px;
            border: 2px solid var(--border); cursor: pointer; transition: all 0.15s;
            background: var(--bg-input); user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .matrix-cell:hover { border-color: var(--primary); }
        .matrix-cell.selected { border-color: var(--primary); background: rgba(79,172,254,0.15); box-shadow: 0 0 0 2px rgba(79,172,254,0.3); }
        .matrix-cell.modified { border-color: var(--purple); background: rgba(167,139,250,0.12); }
        .matrix-cell.zero { opacity: 0.5; }
        .matrix-cell.zero .matrix-cell-stock { text-decoration: line-through; color: var(--danger); }
        .matrix-cell-size { font-size: 0.65em; color: var(--text-secondary); font-weight: 600; }
        .matrix-cell-stock { font-size: 1.1em; font-weight: 800; margin-top: 1px; }
        .matrix-cell-stock.high { color: var(--success); }
        .matrix-cell-stock.med { color: var(--warning); }
        .matrix-cell-stock.low { color: var(--danger); }
        .matrix-controls {
            position: sticky; bottom: 0; background: var(--bg-card); border-top: 1px solid var(--border);
            padding: 10px 0 4px; margin-top: 12px; display: none; align-items: center; gap: 8px; justify-content: center;
        }
        .matrix-controls.show { display: flex; }
        .matrix-controls-label { font-size: 0.75em; color: var(--text-secondary); max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .matrix-ctrl-btn {
            width: 44px; height: 44px; border-radius: 10px; border: 1px solid var(--border);
            background: var(--bg-input); color: var(--text); font-size: 1.3em; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        .matrix-ctrl-btn.minus { color: var(--danger); }
        .matrix-ctrl-btn.minus:active { background: rgba(239,68,68,0.2); }
        .matrix-ctrl-btn.plus { color: var(--success); }
        .matrix-ctrl-btn.plus:active { background: rgba(34,197,94,0.2); }
        .matrix-ctrl-btn.zero-btn { font-size: 1em; color: var(--warning); }
        .matrix-ctrl-val { font-size: 1.4em; font-weight: 800; min-width: 36px; text-align: center; }
        .matrix-manual { width: 50px; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text); text-align: center; font-size: 0.95em; }
        .matrix-set-btn { padding: 8px 12px; border-radius: 8px; border: none; background: var(--primary); color: white; font-weight: 700; cursor: pointer; font-size: 0.85em; }
        @media (max-width: 640px) {
            .matrix-cell { width: 50px; padding: 5px 2px; }
            .matrix-ctrl-btn { width: 40px; height: 40px; }
        }

        .toggle {
            position: relative; display: inline-block; width: 48px; height: 26px; cursor: pointer;
            -webkit-tap-highlight-color: transparent; flex-shrink: 0; vertical-align: middle;
        }
        .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
        .toggle-slider {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: #555; border-radius: 26px; transition: 0.3s;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        .toggle-slider::before {
            content: ''; position: absolute; height: 20px; width: 20px;
            left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        .toggle input:checked + .toggle-slider { background: #4facfe; }
        .toggle input:checked + .toggle-slider::before { transform: translateX(22px); }
        [data-theme="light"] .toggle-slider { background: #ccc; }
        [data-theme="light"] .toggle input:checked + .toggle-slider { background: #4facfe; }
        
        /* Select dropdown in settings */
        .setting-select {
            background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
            padding: 8px 12px; border-radius: 8px; font-size: 0.85em; cursor: pointer;
            -webkit-appearance: none; appearance: none; min-width: 100px; text-align: right;
        }
        
        /* Number input in settings */
        .setting-number {
            background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
            padding: 8px 10px; border-radius: 8px; font-size: 0.9em; width: 70px;
            text-align: center;
        }
        
        /* Compact mode */
        body.compact .product-item { padding: 8px 10px; gap: 8px; }
        body.compact .product-meta { font-size: 0.85em; }
        body.compact .product-sku { font-size: 0.68em; }
        body.compact .product-name { font-size: 0.7em; }
        body.compact .stock-num { font-size: 1.3em; }
        body.compact .color-divider { padding: 6px 10px; font-size: 0.75em; }
        
        /* Stats row */
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;
        }
        .stat-box {
            background: var(--bg-input); border-radius: 8px; padding: 10px;
            text-align: center; border: 1px solid var(--border);
        }
        .stat-value { font-size: 1.3em; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.68em; color: var(--text-secondary); margin-top: 2px; }
        
        /* ============ ARTICLE DETAIL VIEW ============ */
        .article-detail-view { display: none; list-style: none; }
        .article-detail-view.active { display: block; }
        .article-detail-view * { list-style: none; }
        
        .article-sticky-name {
            position: sticky; top: 0; z-index: 60;
            background: var(--primary); color: white;
            padding: 10px 16px; font-weight: 800; font-size: 1.05em;
            text-align: center; text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .article-hero-placeholder {
            width: 100%; height: 80px; background: var(--bg-input);
            display: flex; align-items: center; justify-content: center;
            font-size: 2em; color: var(--text-secondary); border-radius: 0 0 12px 12px;
        }
        
        .article-stats-row {
            display: flex; gap: 8px; padding: 6px 10px; justify-content: center;
            font-size: 0.78em; color: var(--text-secondary); margin-bottom: 4px;
        }
        .article-stats-row strong { color: var(--primary); }
        
        .article-color-section {
            margin-bottom: 2px;
            background: var(--bg-card);
        }
        
        .article-color-sticky {
            position: sticky; top: 42px; z-index: 55;
            background: var(--bg-card); border-bottom: 2px solid var(--primary);
            padding: 7px 50px 7px 14px; font-weight: 700; font-size: 0.9em;
            color: var(--primary); display: flex; align-items: center;
            justify-content: center; gap: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .article-color-sticky .color-stock-badge {
            font-size: 0.78em; color: var(--text-secondary); font-weight: 400;
            position: absolute; right: 14px;
        }
        .article-color-img {
            width: calc(100% - 16px); max-height: 220px; object-fit: contain;
            background: var(--bg-input); display: none; border-radius: 10px;
            margin: 6px auto; cursor: pointer;
        }
        .article-detail-view.show-photos .article-color-img { display: block; }
        
        .article-photo-toggle {
            padding: 5px 12px; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 16px; font-size: 0.72em; color: var(--text-secondary); cursor: pointer;
            font-weight: 600; -webkit-tap-highlight-color: transparent;
        }
        .article-photo-toggle.active { background: var(--primary); border-color: var(--primary); color: white; }
        
        .article-sizes-grid {
            display: flex; flex-wrap: nowrap; gap: 3px; padding: 6px 4px;
            justify-content: center; overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .article-sizes-grid::-webkit-scrollbar { display: none; }
        
        .article-size-cell {
            min-width: 48px; flex: 1; max-width: 68px;
            text-align: center; padding: 8px 2px; border-radius: 10px;
            border: 2px solid var(--border); cursor: pointer; transition: all 0.15s;
            background: var(--bg-card); user-select: none;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        .article-size-cell:active { transform: scale(0.95); }
        .article-size-cell.selected {
            border-color: var(--primary); background: rgba(79,172,254,0.18);
            box-shadow: 0 0 0 2px rgba(79,172,254,0.3);
        }
        .article-size-cell.modified {
            border-color: var(--purple); background: rgba(167,139,250,0.12);
        }
        .article-size-cell.zero { opacity: 0.5; }
        .article-size-cell.zero .asc-stock { text-decoration: line-through; color: var(--danger); }
        
        .asc-size { font-size: 0.72em; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; }
        .asc-stock { font-size: 1.35em; font-weight: 800; margin-top: 2px; line-height: 1; }
        .asc-stock.high { color: var(--success); }
        .asc-stock.med { color: var(--warning); }
        .asc-stock.low { color: var(--danger); }
        
        .article-edit-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-card); border-top: 2px solid var(--primary);
            padding: 6px 10px 8px; z-index: 110;
            display: none; flex-direction: column; align-items: center; gap: 4px;
            box-shadow: 0 -4px 16px rgba(0,0,0,0.5);
        }
        .article-edit-bar.show { display: flex; }
        .edit-bar-top {
            font-size: 0.82em; font-weight: 700; color: var(--primary);
            text-align: center; width: 100%;
        }
        .edit-bar-controls {
            display: flex; align-items: center; gap: 6px; justify-content: center;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .article-edit-bar .stock-btn {
            width: 52px; height: 52px; border-radius: 12px; font-size: 1.6em;
        }
        .article-edit-bar .edit-val {
            font-size: 1.5em; font-weight: 800; min-width: 36px; text-align: center;
        }
        .article-edit-bar .stock-manual-input {
            width: 50px; padding: 10px 4px; font-size: 16px; border-radius: 8px;
            border: 1px solid var(--border); background: var(--bg-input); color: var(--text);
            text-align: center; font-weight: 700;
        }
        .article-edit-bar .stock-set-btn {
            padding: 12px 14px; border-radius: 10px; border: none;
            background: var(--primary); color: white; font-weight: 700; font-size: 1em; cursor: pointer;
            min-height: 52px;
        }
        
        @media (max-width: 640px) {
            .article-sticky-name { font-size: 0.95em; padding: 8px 12px; }
            .article-color-sticky { top: 38px; font-size: 0.85em; padding: 7px 12px; }
            .article-size-cell { min-width: 44px; padding: 7px 2px; }
            .asc-stock { font-size: 1.15em; }
            .asc-size { font-size: 0.68em; }
            .article-edit-bar { 
                padding: 5px 6px calc(6px + env(safe-area-inset-bottom, 0px)); gap: 3px; 
            }
            .article-edit-bar .stock-btn { width: 50px; height: 50px; font-size: 1.5em; }
            .article-edit-bar .stock-set-btn { min-height: 50px; padding: 10px 12px; }
            .article-color-img { max-height: 180px; }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner">‚è≥</div>
        <div class="loading-text" id="loadingText">Cargando inventario...</div>
        <div class="loading-error" id="loadingError"></div>
    </div>

    <div class="header-bar">
      <div class="header-bar-inner">
        <div class="header-left">
            <span class="header-title">üìä Mikra</span>
            <div class="sync-inline">
                <div class="sync-dot" id="syncDot"></div>
                <span id="syncStatus">Cargando...</span>
                <span id="syncTime"></span>
            </div>
        </div>
        <div class="header-right">
            <button class="icon-btn" onclick="loadData(true)" title="Sincronizar">üîÑ</button>
            <button class="icon-btn" onclick="openSettings()" title="Configuraci√≥n">‚öôÔ∏è</button>
        </div>
      </div>
    </div>

    <div class="offline-bar" id="offlineBar">üì¥ Sin conexi√≥n ‚Äî cambios se guardan localmente</div>

    <div class="container">
        <div class="search-container">
            <div class="search-box">
                <span>üîç</span>
                <input type="text" id="searchInput" placeholder="Buscar por nombre, SKU, color, ubicaci√≥n...">
                <button class="search-clear" id="searchClear" onclick="clearSearch()">‚úï Borrar</button>
            </div>
            <div class="autocomplete" id="autocomplete"></div>
        </div>

        <div class="filter-row">
            <div class="filter-chip active stock" data-stock="all">üì¶ Todos</div>
            <div class="filter-chip stock" data-stock="yes">‚úÖ Con Stock</div>
            <div class="filter-chip critical" data-stock="critical">‚ö†Ô∏è Sin/Bajo Stock</div>
            <div class="filter-chip low" data-stock="low">üî∂ Bajo Stock</div>
            <div class="filter-chip out" data-stock="no">‚ùå Sin Stock</div>
            <div class="filter-chip" id="locationBtn" onclick="toggleLocationSearch()">üìç Ubicaci√≥n</div>
            <div class="filter-chip" id="photosBtn" onclick="togglePhotos()">üì∑ Fotos</div>
            <div class="filter-chip modified-chip" data-stock="modified" id="modifiedChip" style="display:none;">‚úèÔ∏è Modif. (<span id="modChipCount">0</span>)</div>
        </div>

        <div class="location-search" id="locationSearch" style="display: none; margin-bottom: 10px;">
            <div class="search-box" style="margin-bottom: 0;">
                <span>üìç</span>
                <input type="text" id="locationInput" placeholder="Ej: 1000, 3000, 4000..." onkeyup="filterByLocation()">
                <button class="search-clear show" onclick="clearLocationSearch()">‚úï</button>
            </div>
        </div>

        <div class="filters-collapse" id="filtersCollapse">
            <div class="filters-header" onclick="toggleFilters()">
                <span>üé® Color / üìè Talle</span>
                <div style="display:flex;align-items:center;gap:6px;">
                    <button class="clear-filters-btn" id="clearFiltersBtn" onclick="event.stopPropagation(); clearAllFilters();">‚úï Limpiar</button>
                    <button class="multi-toggle" id="galleryChip" onclick="event.stopPropagation(); openColorGallery();" style="display:none;">üñºÔ∏è Color x Foto</button>
                    <div class="active-filters" id="activeFilters"></div>
                    <span class="filters-arrow">‚ñº</span>
                </div>
            </div>
            <div class="filters-body">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="filter-section-title">üé® Colores</div>
                    <button class="multi-toggle" id="multiToggle" onclick="toggleMultiSelect();">‚ò∞ Multi Color</button>
                </div>
                <div class="filter-options" id="colorOptions"></div>
                <div class="filter-section-title">üìè Talles</div>
                <div class="filter-options" id="sizeOptions"></div>
            </div>
        </div>

        <div class="color-gallery-overlay" id="colorGallery">
            <div class="color-gallery-header">
                <div class="color-gallery-title" id="colorGalleryTitle">üñºÔ∏è Colores</div>
                <button class="color-gallery-close" onclick="closeColorGallery()">‚úï</button>
            </div>
            <div class="color-gallery-grid" id="colorGalleryGrid"></div>
        </div>

        <div class="results-info">
            Mostrando <strong id="showingCount">0</strong> de <strong id="totalCount">0</strong> productos
        </div>

        <div class="product-list" id="productList"></div>
        <div class="pagination" id="pagination"></div>
        
        <div class="article-detail-view" id="articleDetailView">
            <div class="article-sticky-name" id="articleStickyName"></div>
            <div id="articleDetailContent"></div>
        </div>
    </div>

    <div class="article-edit-bar" id="articleEditBar">
        <button onclick="articleCloseEditBar()" style="position:absolute;top:4px;right:8px;background:none;border:none;color:var(--text-secondary);font-size:1.3em;cursor:pointer;padding:4px 8px;line-height:1;">‚úï</button>
        <div class="edit-bar-top" id="articleEditLabel">‚Äî</div>
        <div class="edit-bar-controls">
            <button class="stock-btn minus" onclick="articleModify(-1)">‚àí</button>
            <div class="edit-val" id="articleEditVal">0</div>
            <button class="stock-btn plus" onclick="articleModify(1)">+</button>
            <button class="stock-btn zero" onclick="articleSetZero()">‚äò</button>
            <input type="number" class="stock-manual-input" id="articleManualInput" placeholder="#" min="0">
            <button class="stock-set-btn" onclick="articleSetManual()">‚úì</button>
        </div>
    </div>

    <div class="bottom-bar">
      <div class="bottom-bar-inner">
        <div class="modifications-summary">
            <div class="mod-count">
                Modificaciones: <strong id="modCount">0</strong>
            </div>
        </div>
        <div class="action-buttons">
            <button class="action-btn view" onclick="viewModifications()" id="viewBtn" disabled>
                üìã Ver Lista
            </button>
            <button class="action-btn copy" onclick="copyForWhatsApp()" id="copyBtn" disabled>
                üí¨ Copiar WhatsApp
            </button>
            <button class="action-btn clear" onclick="clearModifications()" id="clearBtn" disabled>
                üóëÔ∏è Limpiar
            </button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Modificaciones</div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <div class="img-modal-overlay" id="imgModal" onclick="closeImgModal()">
        <button class="img-modal-close" onclick="closeImgModal()">‚úï</button>
        <img id="imgModalSrc" src="" alt="Producto">
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxKNkORm0oMVtcODYJC3UNbxwn3_O9tP7_9DS9R35f2d6JZTAn6UBWrYH--Bp0Y_LWV/exec';
        // API del inventario (tiene las im√°genes)
        const IMAGES_API_URL = 'https://script.google.com/macros/s/AKfycbxiST8drkv_bXz5n8ZW8ZzeWNotXAb24Z8MCW7FU8KoGoqf0Th10CHBR-9vQI5MbSPb/exec';
        const SIZE_ORDER = ['XXS', 'XS', 'S', 'M', 'L', 'XL', 'XXL', '2XL', '3XL'];
        
        let PRODUCTS = [];
        let UNIQUE_ARTICLES = [];
        let IMAGES_MAP = {};
        
        const state = {
            search: '',
            searchExact: false,
            stock: 'all',
            colors: [],
            sizes: [],
            location: '',
            filtered: [],
            modifications: {},
            page: 1,
            pageSize: 50,
            lowStockThreshold: 5,
            showImages: false,
            multiSelect: false,
            theme: 'dark',
            compactMode: false,
            defaultImages: false,
            autoSyncMin: 10,
            showSku: false
        };
        
        function $(id) { return document.getElementById(id); }
        
        // === PERSISTENCIA ===
        function saveModifications() {
            try { localStorage.setItem('mikra_modifications', JSON.stringify(state.modifications)); } catch(e) {}
        }
        function loadModifications() {
            try {
                const saved = localStorage.getItem('mikra_modifications');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Migrate old numeric-keyed mods to SKU-keyed
                    const migrated = {};
                    Object.entries(parsed).forEach(([key, mod]) => {
                        if (mod && mod.product && mod.product.codigo) {
                            migrated[mod.product.codigo] = mod; // use SKU as key
                        } else {
                            migrated[key] = mod; // already SKU-keyed or unknown
                        }
                    });
                    state.modifications = migrated;
                }
            } catch(e) {}
        }
        
        // === IM√ÅGENES ===
        function loadImagesFromCache() {
            try { IMAGES_MAP = JSON.parse(localStorage.getItem('mikra_images') || '{}'); } catch(e) {}
        }
        
        async function loadImagesFromAPI() {
            // Si ya hay im√°genes en cach√©, no recargar
            if (Object.keys(IMAGES_MAP).length > 0) return;
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 10000);
                const resp = await fetch(IMAGES_API_URL, { signal: controller.signal });
                clearTimeout(timeout);
                const data = await resp.json();
                if (data.images) {
                    IMAGES_MAP = data.images;
                    localStorage.setItem('mikra_images', JSON.stringify(IMAGES_MAP));
                }
            } catch(e) { /* silencioso, usar√° cach√© */ }
        }
        
        function getProductImage(codigo, product) {
            if (!codigo) return '';
            // 1. Buscar imagen directa por c√≥digo
            let url = IMAGES_MAP[codigo] || IMAGES_MAP[String(codigo)] || '';
            
            // 2. Fallback: buscar en otro talle del mismo art√≠culo y color
            if (!url && product) {
                const nombre = (product.titulo || product.articulo || '').toLowerCase();
                const color = (product.color || '').toLowerCase();
                if (nombre && color) {
                    for (const p of PRODUCTS) {
                        if (p.codigo === codigo) continue;
                        const pNombre = (p.titulo || p.articulo || '').toLowerCase();
                        const pColor = (p.color || '').toLowerCase();
                        if (pNombre === nombre && pColor === color) {
                            url = IMAGES_MAP[p.codigo] || IMAGES_MAP[String(p.codigo)] || '';
                            if (url) break;
                        }
                    }
                }
            }
            
            if (!url) return '';
            return url.replace(/-O\.jpg$/i, '-S.jpg');
        }
        
        function getProductImageFull(codigo, product) {
            if (!codigo) return '';
            let url = IMAGES_MAP[codigo] || IMAGES_MAP[String(codigo)] || '';
            
            if (!url && product) {
                const nombre = (product.titulo || product.articulo || '').toLowerCase();
                const color = (product.color || '').toLowerCase();
                if (nombre && color) {
                    for (const p of PRODUCTS) {
                        if (p.codigo === codigo) continue;
                        const pNombre = (p.titulo || p.articulo || '').toLowerCase();
                        const pColor = (p.color || '').toLowerCase();
                        if (pNombre === nombre && pColor === color) {
                            url = IMAGES_MAP[p.codigo] || IMAGES_MAP[String(p.codigo)] || '';
                            if (url) break;
                        }
                    }
                }
            }
            
            return url || '';
        }
        
        function showImgModal(codigo, productId) {
            const product = productId ? PRODUCTS.find(p => p.id === productId) : null;
            const url = getProductImageFull(codigo, product);
            if (!url) return;
            $('imgModalSrc').src = url;
            $('imgModal').classList.add('show');
        }
        
        function closeImgModal() {
            $('imgModal').classList.remove('show');
            $('imgModalSrc').src = '';
        }
        
        function togglePhotos() {
            state.showImages = !state.showImages;
            $('photosBtn').classList.toggle('active', state.showImages);
            $('productList').classList.toggle('show-images', state.showImages);
        }
        
        // === GALER√çA DE COLORES POR IMAGEN ===
        function openColorGallery() {
            // Obtener los colores disponibles del art√≠culo buscado
            const results = getPreFilteredResults();
            const colorData = {};
            
            results.forEach(p => {
                if (!p.color) return;
                if (!colorData[p.color]) {
                    colorData[p.color] = { color: p.color, totalStock: 0, imgUrl: '', product: null };
                }
                colorData[p.color].totalStock += p.stock || 0;
                // Buscar imagen para este color si a√∫n no tenemos
                if (!colorData[p.color].imgUrl) {
                    const img = getProductImageFull(p.codigo, p);
                    if (img) {
                        colorData[p.color].imgUrl = img;
                        colorData[p.color].product = p;
                    }
                }
            });
            
            const colors = Object.values(colorData).sort((a, b) => a.color.localeCompare(b.color));
            
            if (!colors.length) {
                toast('No hay colores para mostrar', 'warning');
                return;
            }
            
            // T√≠tulo
            const articleName = state.search || 'Art√≠culo';
            $('colorGalleryTitle').textContent = 'üñºÔ∏è ' + articleName;
            
            // Generar grilla
            let html = '';
            colors.forEach(c => {
                const isActive = state.colors.includes(c.color);
                const noStock = c.totalStock <= 0;
                const thumbUrl = c.imgUrl ? c.imgUrl.replace(/-O\.jpg$/i, '-I.jpg') : '';
                
                html += '<div class="color-gallery-item' + (isActive ? ' active' : '') + (noStock ? ' no-stock-gallery' : '') + '" onclick="selectColorFromGallery(\'' + c.color.replace(/'/g, "\\'") + '\')">';
                
                if (thumbUrl) {
                    html += '<img class="color-gallery-img" loading="lazy" src="' + thumbUrl + '" onerror="this.outerHTML=\'<div class=color-gallery-img-placeholder>üì¶</div>\'">';
                } else {
                    html += '<div class="color-gallery-img-placeholder">üì¶</div>';
                }
                
                html += '<div class="color-gallery-label">' + c.color;
                html += '<span class="color-gallery-stock' + (noStock ? ' out' : '') + '">' + (noStock ? 'Sin stock' : c.totalStock + ' uds') + '</span>';
                html += '</div></div>';
            });
            
            $('colorGalleryGrid').innerHTML = html;
            $('colorGallery').classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        function closeColorGallery() {
            $('colorGallery').classList.remove('show');
            document.body.style.overflow = '';
        }
        
        function selectColorFromGallery(color) {
            if (state.multiSelect) {
                const idx = state.colors.indexOf(color);
                if (idx > -1) state.colors.splice(idx, 1);
                else state.colors.push(color);
            } else {
                state.colors = state.colors.length === 1 && state.colors[0] === color ? [] : [color];
            }
            closeColorGallery();
            applyFilters();
        }
        
        // Obtener productos pre-filtrados (antes de color/talle) para la galer√≠a
        function getPreFilteredResults() {
            let r = SEARCH_INDEX.length ? [...SEARCH_INDEX] : [...PRODUCTS];
            if (state.stock === 'yes') r = r.filter(p => p.stock > 0);
            else if (state.stock === 'low') r = r.filter(p => p.stock > 0 && p.stock <= state.lowStockThreshold);
            else if (state.stock === 'no') r = r.filter(p => p.stock === 0);
            else if (state.stock === 'critical') r = r.filter(p => p.stock <= state.lowStockThreshold);
            else if (state.stock === 'modified') r = r.filter(p => !!state.modifications[p.codigo]);
            
            if (state.search) {
                const q = state.search.toLowerCase();
                if (state.searchExact) {
                    r = r.filter(p => (p._titulo || (p.titulo||'').toLowerCase()) === q || (p._articulo || (p.articulo||'').toLowerCase()) === q);
                } else {
                    r = r.filter(p => (p._search || '').includes(q));
                }
            }
            if (state.location) {
                const loc = state.location.toLowerCase();
                r = r.filter(p => (p._ubicacion || (p.ubicacion||'').toLowerCase()).includes(loc));
            }
            return r;
        }
        
        // Mostrar/ocultar bot√≥n de galer√≠a seg√∫n si hay b√∫squeda activa
        function updateGalleryButton() {
            const hasSearch = state.search.length > 0;
            const preResults = hasSearch ? getPreFilteredResults() : [];
            const hasMultipleColors = hasSearch && new Set(preResults.map(p => p.color).filter(Boolean)).size > 1;
            $('galleryChip').style.display = hasMultipleColors ? '' : 'none';
        }
        
        // === MULTI-SELECT TOGGLE ===
        function toggleMultiSelect() {
            state.multiSelect = !state.multiSelect;
            $('multiToggle').classList.toggle('active', state.multiSelect);
            if (!state.multiSelect) {
                if (state.colors.length > 1) state.colors = [state.colors[state.colors.length - 1]];
                applyFilters();
            }
        }
        
        function clearAllFilters() {
            state.colors = [];
            state.sizes = [];
            state.multiSelect = false;
            $('multiToggle').classList.remove('active');
            applyFilters();
        }
        
        function updateClearFiltersBtn() {
            const hasFilters = state.colors.length > 0 || state.sizes.length > 0;
            $('clearFiltersBtn').classList.toggle('show', hasFilters);
        }
        
        function toggleFilters() { $('filtersCollapse').classList.toggle('open'); }
        
        function toggleLocationSearch() {
            const isVisible = $('locationSearch').style.display !== 'none';
            $('locationSearch').style.display = isVisible ? 'none' : 'block';
            $('locationBtn').classList.toggle('active', !isVisible);
            
            if (!isVisible) {
                $('locationInput').focus();
            } else {
                clearLocationSearch();
            }
        }
        
        const debouncedLocationFilter = debounce(() => { applyFilters(); }, 150);
        
        function filterByLocation() {
            state.location = $('locationInput').value.trim();
            debouncedLocationFilter();
        }
        
        function clearLocationSearch() {
            $('locationInput').value = '';
            state.location = '';
            $('locationSearch').style.display = 'none';
            $('locationBtn').classList.remove('active');
            applyFilters();
        }
        
        // EXACTAMENTE LA MISMA FUNCI√ìN DEL ARCHIVO QUE FUNCIONA
        function updateUniqueArticles() {
            const articles = {};
            PRODUCTS.forEach(p => {
                const name = p.titulo || p.articulo || '';
                if (name) {
                    if (!articles[name]) articles[name] = { name, totalStock: 0 };
                    articles[name].totalStock += p.stock || 0;
                }
            });
            UNIQUE_ARTICLES = Object.values(articles).sort((a, b) => b.totalStock - a.totalStock);
        }
        
        function showAutocomplete(query) {
            if (!query || query.length < 2) { $('autocomplete').classList.remove('show'); return; }
            const q = query.toLowerCase();
            const matches = UNIQUE_ARTICLES.filter(a => a.name.toLowerCase().includes(q)).slice(0, 10);
            if (!matches.length) { $('autocomplete').classList.remove('show'); return; }
            
            $('autocomplete').innerHTML = matches.map(a => 
                '<div class="autocomplete-item" data-name="' + a.name.replace(/"/g, '&quot;') + '">' +
                '<span class="autocomplete-name">' + a.name + '</span>' +
                '<span class="autocomplete-stock">' + a.totalStock + ' uds</span></div>'
            ).join('');
            $('autocomplete').classList.add('show');
        }
        
        function clearSearch() {
            $('searchInput').value = '';
            state.search = ''; state.searchExact = false; state.colors = []; state.sizes = [];
            state.multiSelect = false; $('multiToggle').classList.remove('active');
            $('searchClear').classList.remove('show');
            $('autocomplete').classList.remove('show');
            forceListView = false;
            applyFilters();
        }
        
        function applyFilters() {
            // Use pre-computed search index if available
            let r = SEARCH_INDEX.length ? [...SEARCH_INDEX] : [...PRODUCTS];
            
            if (state.stock === 'yes') r = r.filter(p => p.stock > 0);
            else if (state.stock === 'low') r = r.filter(p => p.stock > 0 && p.stock <= state.lowStockThreshold);
            else if (state.stock === 'no') r = r.filter(p => p.stock === 0);
            else if (state.stock === 'critical') r = r.filter(p => p.stock <= state.lowStockThreshold);
            else if (state.stock === 'modified') r = r.filter(p => !!state.modifications[p.codigo]);
            
            if (state.search) {
                const q = state.search.toLowerCase();
                if (state.searchExact) {
                    r = r.filter(p => (p._titulo || (p.titulo||'').toLowerCase()) === q || (p._articulo || (p.articulo||'').toLowerCase()) === q);
                } else {
                    // Use pre-computed _search field (single string.includes instead of 5)
                    r = r.filter(p => (p._search || '').includes(q));
                }
            }
            
            if (state.location) {
                const loc = state.location.toLowerCase();
                r = r.filter(p => (p._ubicacion || (p.ubicacion||'').toLowerCase()).includes(loc));
            }
            
            updateDynamicFilters(r);
            if (state.colors.length > 0) r = r.filter(p => state.colors.includes(p.color));
            if (state.sizes.length > 0) r = r.filter(p => state.sizes.includes(p.talle));
            
            r = sortProducts(r);
            state.filtered = r; state.page = 1;
            render(); updateActiveFilterTags(); updateClearFiltersBtn(); updateGalleryButton();
        }
        
        function updateActiveFilterTags() {
            let tags = '';
            state.colors.forEach(c => { tags += '<span class="active-filter-tag">' + c + '</span>'; });
            state.sizes.forEach(s => { tags += '<span class="active-filter-tag">T:' + s + '</span>'; });
            $('activeFilters').innerHTML = tags;
        }
        
        function updateDynamicFilters(results) {
            const colors = [...new Set(results.map(p => p.color).filter(Boolean))].sort();
            const sizes = [...new Set(results.map(p => p.talle).filter(Boolean))];
            sizes.sort((a, b) => {
                const numA = parseInt(a), numB = parseInt(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                const idxA = SIZE_ORDER.indexOf(a.toUpperCase());
                const idxB = SIZE_ORDER.indexOf(b.toUpperCase());
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                return a.localeCompare(b);
            });
            
            // Stock total por color (sobre todos los results)
            const colorStock = {};
            results.forEach(p => { if (p.color) { colorStock[p.color] = (colorStock[p.color] || 0) + (p.stock || 0); } });
            
            // Stock total por talle ‚Äî FILTRADO por colores seleccionados
            const sizeResults = state.colors.length > 0 
                ? results.filter(p => state.colors.includes(p.color)) 
                : results;
            const sizeStock = {};
            sizeResults.forEach(p => { if (p.talle) { sizeStock[p.talle] = (sizeStock[p.talle] || 0) + (p.stock || 0); } });
            
            // Stock total por color ‚Äî FILTRADO por talles seleccionados
            const colorResults = state.sizes.length > 0
                ? results.filter(p => state.sizes.includes(p.talle))
                : results;
            const colorStockFiltered = {};
            colorResults.forEach(p => { if (p.color) { colorStockFiltered[p.color] = (colorStockFiltered[p.color] || 0) + (p.stock || 0); } });
            
            $('colorOptions').innerHTML = '<div class="filter-opt' + (state.colors.length === 0 ? ' active' : '') + '" data-color="">Todos</div>' +
                colors.map(c => {
                    const noStock = (colorStockFiltered[c] || 0) <= 0;
                    const active = state.colors.includes(c);
                    return '<div class="filter-opt' + (active ? ' active' : '') + (noStock ? ' no-stock-color' : '') + '" data-color="' + c + '">' + c + '</div>';
                }).join('');
            
            $('sizeOptions').innerHTML = '<div class="filter-opt' + (state.sizes.length === 0 ? ' active' : '') + '" data-size="">Todos</div>' +
                sizes.map(s => {
                    const noStock = (sizeStock[s] || 0) <= 0;
                    const active = state.sizes.includes(s);
                    return '<div class="filter-opt' + (active ? ' active' : '') + (noStock ? ' no-stock-color' : '') + '" data-size="' + s + '">' + s + '</div>';
                }).join('');
        }
        
        // EXACTAMENTE LA MISMA FUNCI√ìN DEL ARCHIVO QUE FUNCIONA
        function sortProducts(products) {
            return products.sort((a, b) => {
                const colorA = a._color || (a.color || '').toLowerCase();
                const colorB = b._color || (b.color || '').toLowerCase();
                if (colorA !== colorB) return colorA.localeCompare(colorB);
                
                const sizeA = a.talle || '', sizeB = b.talle || '';
                const numA = parseInt(sizeA), numB = parseInt(sizeB);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                
                const idxA = SIZE_ORDER.indexOf(sizeA.toUpperCase());
                const idxB = SIZE_ORDER.indexOf(sizeB.toUpperCase());
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                return sizeA.localeCompare(sizeB);
            });
        }
        
        function render() {
            // Article detail mode
            if (isArticleDetailMode()) {
                renderArticleDetail();
                updateModificationCount();
                return;
            }
            
            // Normal list mode
            hideArticleDetail();
            
            const start = (state.page - 1) * state.pageSize;
            const items = state.filtered.slice(start, start + state.pageSize);
            const totalPages = Math.ceil(state.filtered.length / state.pageSize);
            
            $('showingCount').textContent = Math.min(start + state.pageSize, state.filtered.length);
            $('totalCount').textContent = state.filtered.length.toLocaleString();
            
            if (!items.length) {
                $('productList').innerHTML = '<div class="empty"><div class="empty-icon">üîç</div><div>No se encontraron productos</div></div>';
                $('pagination').innerHTML = '';
                return;
            }
            
            let html = [], lastColor = null;
            
            // Show banner to switch back to detail view when in forceListView
            if (forceListView && state.searchExact && state.search) {
                html.push('<div style="padding:8px;text-align:center;background:var(--bg-input);border-radius:8px;margin-bottom:2px;cursor:pointer;font-size:0.8em;font-weight:600;color:var(--primary);" onclick="switchToDetailView()">üìä Volver a vista detalle</div>');
            }
            
            items.forEach(p => {
                if (p.color !== lastColor) {
                    html.push('<div class="color-divider">üé® ' + (p.color || 'Sin color') + '</div>');
                    lastColor = p.color;
                }
                
                const mod = state.modifications[p.codigo];
                const isModified = !!mod;
                const currentStock = isModified ? mod.newStock : p.stock;
                const stockClass = currentStock > 5 ? 'high' : currentStock > 0 ? 'med' : 'low';
                const noStock = currentStock <= 0;
                
                let stockDisplay = '<div class="stock-num ' + stockClass + '">' + currentStock + '</div>';
                
                if (isModified) {
                    stockDisplay += '<div class="stock-original">Original: ' + p.stock + '</div>';
                    stockDisplay += '<div class="stock-modified">Modificado ‚úì</div>';
                } else {
                    stockDisplay += '<div class="stock-label">actual</div>';
                }
                
                const imgUrl = getProductImage(p.codigo, p);
                const thumbHtml = imgUrl 
                    ? '<img class="product-thumb" loading="lazy" src="' + imgUrl + '" onclick="showImgModal(\'' + p.codigo + '\',' + p.id + ')" onerror="this.outerHTML=\'<div class=product-thumb-placeholder>üì¶</div>\'">'
                    : '<div class="product-thumb-placeholder">üì¶</div>';
                
                html.push('<div class="product-item' + (isModified ? ' modified' : '') + (noStock ? ' no-stock' : '') + '" id="item-' + p.id + '">' +
                    thumbHtml +
                    '<div class="product-info">' +
                    '<div class="product-meta">' + (p.color || '-') + ' ‚Ä¢ Talle ' + (p.talle || '-') + '</div>' +
                    (state.showSku ? '<div class="product-sku">SKU: ' + p.codigo + ' | Ubic: ' + (p.ubicacion || '-') + '</div>' : '') +
                    '<div class="product-name" style="cursor:pointer;" onclick="openArticleMatrix(\'' + (p.titulo || p.articulo || '-').replace(/'/g, "\\'") + '\')"><span style="border-bottom:1px dashed var(--text-secondary)">' + (p.titulo || p.articulo || '-') + '</span> ‚Üó</div></div>' +
                    '<div class="product-right">' +
                    '<div class="product-stock">' + stockDisplay + '</div>' +
                    '<div class="stock-controls">' +
                    '<button class="stock-btn minus" onclick="modifyStock(' + p.id + ', -1, event)">‚àí</button>' +
                    '<button class="stock-btn plus" onclick="modifyStock(' + p.id + ', 1, event)">+</button>' +
                    '<button class="stock-btn zero" onclick="setStockZero(' + p.id + ', event)">‚äò</button>' +
                    '<div class="stock-input-group">' +
                    '<input type="number" class="stock-manual-input" id="manual-' + p.id + '" placeholder="' + currentStock + '" min="0">' +
                    '<button class="stock-set-btn" onclick="setManualStock(' + p.id + ', event)">‚úì</button>' +
                    '</div></div>' +
                    '<button class="mobile-edit-btn" onclick="toggleMobileControls(' + p.id + ', event)" id="editBtn-' + p.id + '">‚úèÔ∏è</button>' +
                    '</div></div>' +
                    '<div class="stock-controls-panel" id="panel-' + p.id + '">' +
                    '<button class="stock-btn minus" onclick="modifyStock(' + p.id + ', -1, event)">‚àí</button>' +
                    '<button class="stock-btn plus" onclick="modifyStock(' + p.id + ', 1, event)">+</button>' +
                    '<button class="stock-btn zero" onclick="setStockZero(' + p.id + ', event)">‚äò</button>' +
                    '<div class="stock-input-group">' +
                    '<input type="number" class="stock-manual-input" id="mobile-manual-' + p.id + '" placeholder="' + currentStock + '" min="0">' +
                    '<button class="stock-set-btn" onclick="setManualStockMobile(' + p.id + ', event)">‚úì</button>' +
                    '</div></div>');
            });
            
            $('productList').innerHTML = html.join('');
            if (state.showImages) $('productList').classList.add('show-images');
            
            if (totalPages > 1) {
                let h = '<button class="page-btn" onclick="goPage(' + (state.page - 1) + ')"' + (state.page === 1 ? ' disabled' : '') + '>‚Äπ</button>';
                for (let i = Math.max(1, state.page - 2); i <= Math.min(totalPages, state.page + 2); i++) {
                    h += '<button class="page-btn' + (i === state.page ? ' active' : '') + '" onclick="goPage(' + i + ')">' + i + '</button>';
                }
                h += '<button class="page-btn" onclick="goPage(' + (state.page + 1) + ')"' + (state.page === totalPages ? ' disabled' : '') + '>‚Ä∫</button>';
                $('pagination').innerHTML = h;
            } else { $('pagination').innerHTML = ''; }
            
            updateModificationCount();
            
            // Re-open active mobile panel after render
            if (activeMobilePanel) {
                const panel = $('panel-' + activeMobilePanel);
                const btn = $('editBtn-' + activeMobilePanel);
                if (panel) panel.classList.add('show');
                if (btn) btn.classList.add('active');
            }
        }
        
        // #5 TARGETED DOM UPDATE - update single product card without full re-render
        function updateSingleProduct(id) {
            const el = $('item-' + id);
            if (!el) { render(); return; } // fallback if card not on screen
            
            const product = PRODUCTS.find(p => p.id === id);
            if (!product) return;
            
            const mod = state.modifications[product.codigo];
            const isModified = !!mod;
            const currentStock = isModified ? mod.newStock : product.stock;
            const stockClass = currentStock > 5 ? 'high' : currentStock > 0 ? 'med' : 'low';
            
            // Update stock number
            const stockNum = el.querySelector('.stock-num');
            if (stockNum) { stockNum.textContent = currentStock; stockNum.className = 'stock-num ' + stockClass; }
            
            // Update modified/no-stock classes
            el.classList.toggle('modified', isModified);
            el.classList.toggle('no-stock', currentStock <= 0);
            
            // Update stock labels
            const stockArea = el.querySelector('.product-stock');
            if (stockArea) {
                let labels = '';
                labels += '<div class="stock-num ' + stockClass + '">' + currentStock + '</div>';
                if (isModified) {
                    labels += '<div class="stock-original">Original: ' + product.stock + '</div>';
                    labels += '<div class="stock-modified">Modificado ‚úì</div>';
                } else {
                    labels += '<div class="stock-label">actual</div>';
                }
                stockArea.innerHTML = labels;
            }
            
            // Update input placeholders
            const manualInput = $('manual-' + id);
            const mobileInput = $('mobile-manual-' + id);
            if (manualInput) manualInput.placeholder = currentStock;
            if (mobileInput) mobileInput.placeholder = currentStock;
            
            updateModificationCount();
        }
        
        // #1 UNDO - toast with undo button
        function toastWithUndo(msg) {
            clearTimeout(undoTimer);
            const t = $('toast');
            t.innerHTML = '<span>' + msg + '</span> <button onclick="undoLast()" class="undo-btn">DESHACER</button>';
            t.className = 'toast show';
            undoTimer = setTimeout(() => { t.className = 'toast'; undoStack.length = 0; }, 4000);
        }
        
        function undoLast() {
            clearTimeout(undoTimer);
            const action = undoStack.pop();
            if (!action) { toast('Nada que deshacer', 'warning'); return; }
            
            if (action.previousMod) {
                state.modifications[action.sku] = action.previousMod;
            } else {
                delete state.modifications[action.sku];
            }
            
            haptic('medium');
            saveModifications();
            render();
            $('toast').className = 'toast';
            toast('‚Ü©Ô∏è Deshecho');
        }
        
        function openMikra(codigo) { window.open('https://www.mikra.com.ar/search/?q=' + codigo, '_blank'); }
        
        let activeMobilePanel = null;
        
        function toggleMobileControls(id, e) {
            e.stopPropagation();
            const panel = $('panel-' + id);
            const btn = $('editBtn-' + id);
            
            if (activeMobilePanel && activeMobilePanel !== id) {
                const oldPanel = $('panel-' + activeMobilePanel);
                const oldBtn = $('editBtn-' + activeMobilePanel);
                if (oldPanel) oldPanel.classList.remove('show');
                if (oldBtn) oldBtn.classList.remove('active');
            }
            
            const isOpen = panel.classList.contains('show');
            panel.classList.toggle('show');
            btn.classList.toggle('active');
            activeMobilePanel = isOpen ? null : id;
        }
        
        function setManualStockMobile(id, e) {
            e.stopPropagation();
            const product = PRODUCTS.find(p => p.id === id);
            if (!product) return;
            const sku = product.codigo;
            
            const input = $('mobile-manual-' + id);
            const value = parseInt(input.value);
            
            if (!input.value || isNaN(value) || value < 0) {
                toast('‚ö†Ô∏è Ingres√° una cantidad v√°lida', 'warning');
                haptic('error');
                input.focus();
                return;
            }
            
            undoStack.push({ sku, previousMod: state.modifications[sku] ? {...state.modifications[sku]} : null, productName: (product.color || '-') + ' T:' + (product.talle || '-') });
            
            state.modifications[sku] = { oldStock: product.stock, newStock: value, product: product };
            if (value === product.stock) delete state.modifications[sku];
            
            haptic('medium');
            saveModifications();
            input.value = '';
            updateSingleProduct(id);
            const diff = value - product.stock;
            toast((diff >= 0 ? '+' : '') + diff);
        }
        
        function goPage(p) {
            const max = Math.ceil(state.filtered.length / state.pageSize);
            if (p < 1 || p > max) return;
            state.page = p; render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        let lastModifyTime = 0; // #8 double-tap prevention
        const undoStack = []; // #1 undo history
        let undoTimer = null;
        
        function haptic(style) { // #10 haptic feedback
            if (navigator.vibrate) {
                if (style === 'error') navigator.vibrate([30, 50, 30]);
                else navigator.vibrate(style === 'medium' ? 25 : 10);
            }
        }
        
        function modifyStock(id, delta, e) {
            e.stopPropagation();
            
            // #8 double-tap prevention (100ms throttle)
            const now = Date.now();
            if (now - lastModifyTime < 100) return;
            lastModifyTime = now;
            
            const product = PRODUCTS.find(p => p.id === id);
            if (!product) return;
            const sku = product.codigo; // #2 use SKU as key
            
            // #1 save undo state BEFORE change
            undoStack.push({
                sku: sku,
                previousMod: state.modifications[sku] ? {...state.modifications[sku]} : null,
                productName: (product.color || '-') + ' T:' + (product.talle || '-')
            });
            
            let mod = state.modifications[sku];
            
            if (!mod) {
                let newStock;
                if (product.stock < 0 && delta > 0) {
                    newStock = delta;
                } else {
                    newStock = product.stock + delta;
                }
                mod = { oldStock: product.stock, newStock: newStock, product: product };
            } else {
                if (mod.newStock < 0 && delta > 0) {
                    mod.newStock = delta;
                } else {
                    mod.newStock += delta;
                }
            }
            
            if (mod.newStock < 0) mod.newStock = 0;
            
            if (mod.newStock === mod.oldStock) {
                delete state.modifications[sku];
            } else {
                state.modifications[sku] = mod;
            }
            
            haptic('light');
            saveModifications();
            updateSingleProduct(id); // #5 targeted update instead of full render
            
            const realChange = (state.modifications[sku] ? state.modifications[sku].newStock : product.stock) - product.stock;
            toastWithUndo((realChange > 0 ? '+' : '') + realChange + ' ' + (product.color || ''));
        }
        
        function setStockZero(id, e) {
            e.stopPropagation();
            const product = PRODUCTS.find(p => p.id === id);
            if (!product) return;
            const sku = product.codigo;
            
            if (!confirm('‚ö†Ô∏è ¬øPoner stock en 0 para ' + (product.color || '-') + ' Talle ' + (product.talle || '-') + '?')) {
                return;
            }
            
            if (product.stock === 0 && !state.modifications[sku]) {
                toast('Ya est√° en 0', 'warning');
                return;
            }
            
            undoStack.push({
                sku: sku,
                previousMod: state.modifications[sku] ? {...state.modifications[sku]} : null,
                productName: (product.color || '-') + ' T:' + (product.talle || '-')
            });
            
            if (product.stock === 0) {
                delete state.modifications[sku];
            } else {
                state.modifications[sku] = {
                    oldStock: product.stock,
                    newStock: 0,
                    product: product
                };
            }
            
            haptic('medium');
            saveModifications();
            updateSingleProduct(id);
            toast('‚úì Puesto en 0');
        }
        
        function setManualStock(id, e) {
            e.stopPropagation();
            const product = PRODUCTS.find(p => p.id === id);
            if (!product) return;
            const sku = product.codigo;
            
            const input = $('manual-' + id);
            const value = parseInt(input.value);
            
            if (!input.value || isNaN(value) || value < 0) {
                toast('‚ö†Ô∏è Ingres√° una cantidad v√°lida', 'warning');
                haptic('error');
                input.focus();
                return;
            }
            
            undoStack.push({ sku, previousMod: state.modifications[sku] ? {...state.modifications[sku]} : null, productName: (product.color || '-') + ' T:' + (product.talle || '-') });
            
            state.modifications[sku] = { oldStock: product.stock, newStock: value, product: product };
            if (value === product.stock) delete state.modifications[sku];
            
            haptic('medium');
            saveModifications();
            input.value = '';
            updateSingleProduct(id);
            const diff = value - product.stock;
            toast((diff >= 0 ? '+' : '') + diff);
        }
        

        // === ARTICLE MATRIX VIEW ===
        let matrixSelectedId = null;
        
        function openArticleMatrix(articleName) {
            // Find all products for this article
            const articleProducts = PRODUCTS.filter(p => (p.titulo || p.articulo || '') === articleName);
            if (!articleProducts.length) { toast('No encontrado', 'warning'); return; }
            
            // Group by color
            const colorGroups = {};
            const allSizes = new Set();
            articleProducts.forEach(p => {
                const color = p.color || 'Sin color';
                if (!colorGroups[color]) colorGroups[color] = {};
                colorGroups[color][p.talle || '-'] = p;
                allSizes.add(p.talle || '-');
            });
            
            // Sort sizes - try numeric first, then SIZE_ORDER, then alpha
            const sizesArr = [...allSizes].sort((a, b) => {
                const na = parseFloat(a), nb = parseFloat(b);
                if (!isNaN(na) && !isNaN(nb)) return na - nb;
                const ia = SIZE_ORDER.indexOf(a.toUpperCase()), ib = SIZE_ORDER.indexOf(b.toUpperCase());
                if (ia > -1 && ib > -1) return ia - ib;
                if (ia > -1) return -1;
                if (ib > -1) return 1;
                return a.localeCompare(b);
            });
            
            // Get image
            const imgUrl = getProductImageFull(articleProducts[0].codigo, articleProducts[0]);
            
            // Total stock
            let totalStock = 0;
            articleProducts.forEach(p => {
                const mod = state.modifications[p.codigo];
                totalStock += mod ? mod.newStock : p.stock;
            });
            const modCount = articleProducts.filter(p => !!state.modifications[p.codigo]).length;
            
            // Build HTML
            let html = '';
            
            // Image
            if (imgUrl) {
                html += '<div style="text-align:center;margin-bottom:10px;"><img src="' + imgUrl + '" style="max-height:180px;border-radius:10px;object-fit:contain;" onerror="this.remove()"></div>';
            }
            
            // Stats line
            html += '<div class="matrix-stats">' +
                '<span>üì¶ ' + articleProducts.length + ' variantes</span>' +
                '<span>üìä Stock total: <b>' + totalStock + '</b></span>' +
                (modCount ? '<span style="color:var(--purple)">‚úèÔ∏è ' + modCount + ' modif.</span>' : '') +
                '</div>';
            
            // Color sections
            const colorNames = Object.keys(colorGroups).sort();
            colorNames.forEach(color => {
                const sizes = colorGroups[color];
                html += '<div class="matrix-color-section">';
                html += '<div class="matrix-color-title">üé® ' + color + '</div>';
                html += '<div class="matrix-grid">';
                
                sizesArr.forEach(size => {
                    const p = sizes[size];
                    if (!p) {
                        // No variant for this size+color ‚Äî empty cell
                        html += '<div class="matrix-cell" style="opacity:0.15;cursor:default;"><div class="matrix-cell-size">' + size + '</div><div class="matrix-cell-stock">‚Äî</div></div>';
                        return;
                    }
                    
                    const mod = state.modifications[p.codigo];
                    const isModified = !!mod;
                    const currentStock = isModified ? mod.newStock : p.stock;
                    const stockClass = currentStock > 5 ? 'high' : currentStock > 0 ? 'med' : 'low';
                    const isZero = currentStock <= 0;
                    
                    html += '<div class="matrix-cell' + (isZero ? ' zero' : '') + (isModified ? ' modified' : '') + '" ' +
                        'data-pid="' + p.id + '" onclick="matrixSelect(' + p.id + ')">' +
                        '<div class="matrix-cell-size">' + size + '</div>' +
                        '<div class="matrix-cell-stock ' + stockClass + '">' + currentStock + '</div>' +
                        '</div>';
                });
                
                html += '</div></div>';
            });
            
            // Controls bar (sticky at bottom)
            html += '<div class="matrix-controls" id="matrixControls">' +
                '<div class="matrix-controls-label" id="matrixLabel">‚Äî</div>' +
                '<button class="matrix-ctrl-btn minus" onclick="matrixModify(-1)">‚àí</button>' +
                '<div class="matrix-ctrl-val" id="matrixVal">0</div>' +
                '<button class="matrix-ctrl-btn plus" onclick="matrixModify(1)">+</button>' +
                '<button class="matrix-ctrl-btn zero-btn" onclick="matrixSetZero()">‚äò</button>' +
                '<input type="number" class="matrix-manual" id="matrixManual" placeholder="#" min="0">' +
                '<button class="matrix-set-btn" onclick="matrixSetManual()">‚úì</button>' +
                '</div>';
            
            matrixSelectedId = null;
            $('modalTitle').textContent = 'üì¶ ' + articleName;
            $('modalBody').innerHTML = html;
            showModal();
        }
        
        function matrixSelect(productId) {
            matrixSelectedId = productId;
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;
            
            // Highlight selected cell
            document.querySelectorAll('.matrix-cell.selected').forEach(c => c.classList.remove('selected'));
            const cell = document.querySelector('.matrix-cell[data-pid="' + productId + '"]');
            if (cell) cell.classList.add('selected');
            
            // Show controls
            const controls = $('matrixControls');
            controls.classList.add('show');
            
            const mod = state.modifications[product.codigo];
            const currentStock = mod ? mod.newStock : product.stock;
            
            $('matrixLabel').textContent = (product.color || '-') + ' T:' + (product.talle || '-');
            $('matrixVal').textContent = currentStock;
            $('matrixManual').value = '';
            
            haptic('light');
        }
        
        function matrixModify(delta) {
            if (!matrixSelectedId) return;
            const product = PRODUCTS.find(p => p.id === matrixSelectedId);
            if (!product) return;
            const sku = product.codigo;
            
            undoStack.push({ sku, previousMod: state.modifications[sku] ? {...state.modifications[sku]} : null, productName: (product.color || '-') + ' T:' + (product.talle || '-') });
            
            let mod = state.modifications[sku];
            if (!mod) {
                mod = { oldStock: product.stock, newStock: Math.max(0, product.stock + delta), product };
            } else {
                mod.newStock = Math.max(0, mod.newStock + delta);
            }
            
            if (mod.newStock === mod.oldStock) delete state.modifications[sku];
            else state.modifications[sku] = mod;
            
            haptic('light');
            saveModifications();
            matrixRefreshCell(product);
            updateModificationCount();
        }
        
        function matrixSetZero() {
            if (!matrixSelectedId) return;
            const product = PRODUCTS.find(p => p.id === matrixSelectedId);
            if (!product) return;
            const sku = product.codigo;
            
            const currentStock = state.modifications[sku] ? state.modifications[sku].newStock : product.stock;
            if (currentStock === 0) { toast('Ya est√° en 0'); return; }
            
            undoStack.push({ sku, previousMod: state.modifications[sku] ? {...state.modifications[sku]} : null, productName: (product.color || '-') + ' T:' + (product.talle || '-') });
            
            state.modifications[sku] = { oldStock: product.stock, newStock: 0, product };
            if (product.stock === 0) delete state.modifications[sku];
            
            haptic('medium');
            saveModifications();
            matrixRefreshCell(product);
            updateModificationCount();
            toast('‚úì Puesto en 0');
        }
        
        function matrixSetManual() {
            if (!matrixSelectedId) return;
            const product = PRODUCTS.find(p => p.id === matrixSelectedId);
            if (!product) return;
            const sku = product.codigo;
            const value = parseInt($('matrixManual').value);
            
            if (isNaN(value) || value < 0) { toast('‚ö†Ô∏è Cantidad inv√°lida', 'warning'); return; }
            
            undoStack.push({ sku, previousMod: state.modifications[sku] ? {...state.modifications[sku]} : null, productName: (product.color || '-') + ' T:' + (product.talle || '-') });
            
            state.modifications[sku] = { oldStock: product.stock, newStock: value, product };
            if (value === product.stock) delete state.modifications[sku];
            
            haptic('medium');
            saveModifications();
            $('matrixManual').value = '';
            matrixRefreshCell(product);
            updateModificationCount();
            toast('‚úì Stock: ' + value);
        }
        
        function matrixRefreshCell(product) {
            const mod = state.modifications[product.codigo];
            const currentStock = mod ? mod.newStock : product.stock;
            const stockClass = currentStock > 5 ? 'high' : currentStock > 0 ? 'med' : 'low';
            const isZero = currentStock <= 0;
            
            const cell = document.querySelector('.matrix-cell[data-pid="' + product.id + '"]');
            if (cell) {
                cell.classList.toggle('zero', isZero);
                cell.classList.toggle('modified', !!mod);
                cell.querySelector('.matrix-cell-stock').className = 'matrix-cell-stock ' + stockClass;
                cell.querySelector('.matrix-cell-stock').textContent = currentStock;
            }
            
            // Update controls display
            $('matrixVal').textContent = currentStock;
        }

        // ============ ARTICLE DETAIL VIEW ============
        let articleSelectedId = null;
        
        function isArticleDetailMode() {
            return state.searchExact && state.search.length > 0 && !forceListView;
        }
        
        function renderArticleDetail() {
            const articleName = state.search;
            const allProducts = PRODUCTS.filter(p => {
                const name = (p.titulo || p.articulo || '').toLowerCase();
                return name === articleName.toLowerCase();
            });
            
            if (!allProducts.length) {
                $('articleDetailView').classList.remove('active');
                return;
            }
            
            // Apply stock filter
            let products = [...allProducts];
            if (state.stock === 'yes') products = products.filter(p => p.stock > 0);
            else if (state.stock === 'low') products = products.filter(p => p.stock > 0 && p.stock <= state.lowStockThreshold);
            else if (state.stock === 'no') products = products.filter(p => p.stock === 0);
            else if (state.stock === 'critical') products = products.filter(p => p.stock <= state.lowStockThreshold);
            else if (state.stock === 'modified') products = products.filter(p => !!state.modifications[p.codigo]);
            
            // Apply color/size filters
            if (state.colors.length > 0) products = products.filter(p => state.colors.includes(p.color));
            if (state.sizes.length > 0) products = products.filter(p => state.sizes.includes(p.talle));
            
            // Show article name
            $('articleStickyName').textContent = articleName;
            
            // Group by color
            const colorGroups = {};
            const allSizes = new Set();
            products.forEach(p => {
                const color = p.color || 'Sin color';
                if (!colorGroups[color]) colorGroups[color] = [];
                colorGroups[color].push(p);
                allSizes.add(p.talle || '-');
            });
            
            // Sort sizes
            const sizesArr = [...allSizes].sort((a, b) => {
                const na = parseFloat(a), nb = parseFloat(b);
                if (!isNaN(na) && !isNaN(nb)) return na - nb;
                const ia = SIZE_ORDER.indexOf(a.toUpperCase()), ib = SIZE_ORDER.indexOf(b.toUpperCase());
                if (ia > -1 && ib > -1) return ia - ib;
                if (ia > -1) return -1;
                if (ib > -1) return 1;
                return a.localeCompare(b);
            });
            
            // Calc total stock
            let totalStock = 0, modCount = 0;
            allProducts.forEach(p => {
                const mod = state.modifications[p.codigo];
                totalStock += mod ? mod.newStock : p.stock;
                if (mod) modCount++;
            });
            
            let html = '';
            
            // Stats + photo toggle + list view toggle
            html += '<div class="article-stats-row">' +
                '<span>üì¶ <strong>' + allProducts.length + '</strong> var.</span>' +
                '<span>üìä <strong>' + totalStock + '</strong></span>' +
                (modCount ? '<span style="color:var(--purple)">‚úèÔ∏è ' + modCount + '</span>' : '') +
                '<button class="article-photo-toggle" id="articlePhotoToggle" onclick="toggleArticlePhotos()">üì∑</button>' +
                '<button class="article-photo-toggle" onclick="switchToListView()">üìù Lista</button>' +
                '</div>';
            
            // Per color
            const colorNames = Object.keys(colorGroups).sort();
            colorNames.forEach(color => {
                const prods = colorGroups[color];
                // Sort by size
                prods.sort((a, b) => {
                    const sa = a.talle || '', sb = b.talle || '';
                    const na = parseFloat(sa), nb = parseFloat(sb);
                    if (!isNaN(na) && !isNaN(nb)) return na - nb;
                    const ia = SIZE_ORDER.indexOf(sa.toUpperCase()), ib = SIZE_ORDER.indexOf(sb.toUpperCase());
                    if (ia > -1 && ib > -1) return ia - ib;
                    return sa.localeCompare(sb);
                });
                
                // Color total stock
                let colorStock = 0;
                prods.forEach(p => {
                    const mod = state.modifications[p.codigo];
                    colorStock += mod ? mod.newStock : p.stock;
                });
                
                // Find image for this color
                let colorImgUrl = '';
                for (const p of prods) {
                    colorImgUrl = getProductImageFull(p.codigo, p);
                    if (colorImgUrl) break;
                }
                
                html += '<div class="article-color-section">';
                html += '<div class="article-color-sticky">üé® ' + color + 
                    '<span class="color-stock-badge">' + colorStock + ' uds</span></div>';
                
                // Color image
                if (colorImgUrl) {
                    html += '<img class="article-color-img" src="' + colorImgUrl + '" onclick="showImgModal(\'' + prods[0].codigo + '\',' + prods[0].id + ')" onerror="this.remove()">';
                }
                
                // Sizes grid - iterate ALL sizes so columns align across colors
                const sizeMap = {};
                prods.forEach(p => { sizeMap[p.talle || '-'] = p; });
                
                html += '<div class="article-sizes-grid">';
                sizesArr.forEach(size => {
                    const p = sizeMap[size];
                    if (!p) {
                        // Placeholder for missing size ‚Äî invisible but keeps alignment
                        html += '<div class="article-size-cell" style="visibility:hidden;"><div class="asc-size">' + size + '</div><div class="asc-stock">0</div></div>';
                        return;
                    }
                    const mod = state.modifications[p.codigo];
                    const isModified = !!mod;
                    const currentStock = isModified ? mod.newStock : p.stock;
                    const stockClass = currentStock > 5 ? 'high' : currentStock > 0 ? 'med' : 'low';
                    const isZero = currentStock <= 0;
                    const isSelected = articleSelectedId === p.id;
                    
                    html += '<div class="article-size-cell' + 
                        (isZero ? ' zero' : '') + 
                        (isModified ? ' modified' : '') + 
                        (isSelected ? ' selected' : '') + 
                        '" data-pid="' + p.id + '" onclick="articleSelectSize(' + p.id + ')">' +
                        '<div class="asc-size">' + (p.talle || '-') + '</div>' +
                        '<div class="asc-stock ' + stockClass + '">' + currentStock + '</div>' +
                        '</div>';
                });
                html += '</div></div>';
            });
            
            if (!products.length) {
                html = '<div class="empty"><div class="empty-icon">üîç</div><div>No hay variantes con estos filtros</div></div>';
            }
            
            $('articleDetailContent').innerHTML = html;
            $('articleDetailView').classList.add('active');
            $('productList').style.display = 'none';
            $('pagination').style.display = 'none';
            
            // Update counts
            $('showingCount').textContent = products.length;
            $('totalCount').textContent = allProducts.length;
            
            // Restore selection if still valid
            if (articleSelectedId) {
                const cell = document.querySelector('.article-size-cell[data-pid="' + articleSelectedId + '"]');
                if (cell) {
                    cell.classList.add('selected');
                    articleUpdateEditBar();
                } else {
                    articleSelectedId = null;
                    $('articleEditBar').classList.remove('show');
                }
            }
        }
        
        function hideArticleDetail() {
            $('articleDetailView').classList.remove('active');
            $('articleDetailView').classList.remove('show-photos');
            $('productList').style.display = '';
            $('pagination').style.display = '';
            $('articleEditBar').classList.remove('show');
            articleSelectedId = null;
        }
        
        function toggleArticlePhotos() {
            const view = $('articleDetailView');
            view.classList.toggle('show-photos');
            const btn = $('articlePhotoToggle');
            if (btn) btn.classList.toggle('active', view.classList.contains('show-photos'));
        }
        
        // Switch to old-style list view (with pencil edit per row)
        let forceListView = false;
        
        function switchToListView() {
            forceListView = true;
            hideArticleDetail();
            render();
        }
        
        function switchToDetailView() {
            forceListView = false;
            render();
        }
        
        function articleSelectSize(productId) {
            articleSelectedId = productId;
            
            // Highlight selected cell
            document.querySelectorAll('.article-size-cell.selected').forEach(c => c.classList.remove('selected'));
            const cell = document.querySelector('.article-size-cell[data-pid="' + productId + '"]');
            if (cell) cell.classList.add('selected');
            
            articleUpdateEditBar();
            haptic('light');
        }
        
        function articleCloseEditBar() {
            articleSelectedId = null;
            document.querySelectorAll('.article-size-cell.selected').forEach(c => c.classList.remove('selected'));
            $('articleEditBar').classList.remove('show');
        }
        
        function articleUpdateEditBar() {
            if (!articleSelectedId) { $('articleEditBar').classList.remove('show'); return; }
            const product = PRODUCTS.find(p => p.id === articleSelectedId);
            if (!product) return;
            
            const mod = state.modifications[product.codigo];
            const currentStock = mod ? mod.newStock : product.stock;
            
            $('articleEditLabel').textContent = 'üé® ' + (product.color || '-') + '  ¬∑  Talle ' + (product.talle || '-');
            $('articleEditVal').textContent = currentStock;
            const stockClass = currentStock > 5 ? 'high' : currentStock > 0 ? 'med' : 'low';
            $('articleEditVal').className = 'edit-val ' + stockClass;
            $('articleManualInput').value = '';
            $('articleEditBar').classList.add('show');
        }
        
        function articleRefreshCell(product) {
            const mod = state.modifications[product.codigo];
            const currentStock = mod ? mod.newStock : product.stock;
            const stockClass = currentStock > 5 ? 'high' : currentStock > 0 ? 'med' : 'low';
            const isZero = currentStock <= 0;
            
            const cell = document.querySelector('.article-size-cell[data-pid="' + product.id + '"]');
            if (cell) {
                cell.classList.toggle('zero', isZero);
                cell.classList.toggle('modified', !!mod);
                const stockEl = cell.querySelector('.asc-stock');
                stockEl.className = 'asc-stock ' + stockClass;
                stockEl.textContent = currentStock;
            }
            
            articleUpdateEditBar();
            updateModificationCount();
        }
        
        function articleModify(delta) {
            if (!articleSelectedId) return;
            const product = PRODUCTS.find(p => p.id === articleSelectedId);
            if (!product) return;
            const sku = product.codigo;
            
            const now = Date.now();
            if (now - lastModifyTime < 100) return;
            lastModifyTime = now;
            
            undoStack.push({ sku, previousMod: state.modifications[sku] ? {...state.modifications[sku]} : null, productName: (product.color || '-') + ' T:' + (product.talle || '-') });
            
            let mod = state.modifications[sku];
            if (!mod) {
                const base = product.stock < 0 && delta > 0 ? 0 : product.stock;
                mod = { oldStock: product.stock, newStock: Math.max(0, base + delta), product };
            } else {
                mod.newStock = Math.max(0, (mod.newStock < 0 && delta > 0) ? delta : mod.newStock + delta);
            }
            
            if (mod.newStock === mod.oldStock) delete state.modifications[sku];
            else state.modifications[sku] = mod;
            
            haptic('light');
            saveModifications();
            articleRefreshCell(product);
            
            const realChange = (state.modifications[sku] ? state.modifications[sku].newStock : product.stock) - product.stock;
            toastWithUndo((realChange > 0 ? '+' : '') + realChange + '  ' + (product.color || '') + ' T:' + (product.talle || ''));
        }
        
        function articleSetZero() {
            if (!articleSelectedId) return;
            const product = PRODUCTS.find(p => p.id === articleSelectedId);
            if (!product) return;
            const sku = product.codigo;
            
            const currentStock = state.modifications[sku] ? state.modifications[sku].newStock : product.stock;
            if (currentStock === 0) { toast('Ya est√° en 0'); return; }
            
            undoStack.push({ sku, previousMod: state.modifications[sku] ? {...state.modifications[sku]} : null, productName: (product.color || '-') + ' T:' + (product.talle || '-') });
            
            state.modifications[sku] = { oldStock: product.stock, newStock: 0, product };
            if (product.stock === 0) delete state.modifications[sku];
            
            haptic('medium');
            saveModifications();
            articleRefreshCell(product);
            toast('‚úì ‚Üí 0  ' + (product.color || '') + ' T:' + (product.talle || ''));
        }
        
        function articleSetManual() {
            if (!articleSelectedId) return;
            const product = PRODUCTS.find(p => p.id === articleSelectedId);
            if (!product) return;
            const sku = product.codigo;
            const value = parseInt($('articleManualInput').value);
            
            if (isNaN(value) || value < 0) { toast('‚ö†Ô∏è Cantidad inv√°lida', 'warning'); return; }
            
            undoStack.push({ sku, previousMod: state.modifications[sku] ? {...state.modifications[sku]} : null, productName: (product.color || '-') + ' T:' + (product.talle || '-') });
            
            state.modifications[sku] = { oldStock: product.stock, newStock: value, product };
            if (value === product.stock) delete state.modifications[sku];
            
            haptic('medium');
            saveModifications();
            $('articleManualInput').value = '';
            articleRefreshCell(product);
            toast('‚úì ' + value + '  ' + (product.color || '') + ' T:' + (product.talle || ''));
        }

        function updateModificationCount() {
            const count = Object.keys(state.modifications).length;
            $('modCount').textContent = count;
            
            const hasModifications = count > 0;
            $('viewBtn').disabled = !hasModifications;
            $('copyBtn').disabled = !hasModifications;
            $('clearBtn').disabled = !hasModifications;
            
            // #7 Show/hide modified filter chip
            $('modifiedChip').style.display = hasModifications ? '' : 'none';
            $('modChipCount').textContent = count;
        }
        
        function viewModifications() {
            const mods = Object.values(state.modifications);
            if (!mods.length) {
                toast('No hay modificaciones', 'warning');
                return;
            }
            
            let html = '';
            mods.forEach(mod => {
                const p = mod.product;
                const change = mod.newStock - mod.oldStock;
                html += '<div class="mod-item">' +
                    '<div style="display: flex; justify-content: space-between; align-items: start;">' +
                    '<div style="flex: 1;">' +
                    '<div class="mod-item-header">' + (p.titulo || p.articulo || '-') + '</div>' +
                    '<div class="mod-item-detail">SKU: ' + p.codigo + '</div>' +
                    '<div class="mod-item-detail">' + (p.color || '-') + ' ‚Ä¢ Talle ' + (p.talle || '-') + '</div>' +
                    '<div class="mod-item-change">' +
                    '<span class="mod-old">' + mod.oldStock + '</span>' +
                    '<span>‚Üí</span>' +
                    '<span class="mod-new">' + mod.newStock + '</span>' +
                    '<span style="color: var(--text-secondary); margin-left: 8px;">(' + (change >= 0 ? '+' : '') + change + ')</span>' +
                    '</div></div>' +
                    '<button onclick="removeModification(\'' + p.codigo.replace(/'/g, "\\'") + '\')" style="background: var(--danger); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600; margin-left: 12px; min-width:44px; min-height:44px; touch-action:manipulation;">üóëÔ∏è</button>' +
                    '</div></div>';
            });
            
            $('modalTitle').textContent = 'Modificaciones (' + mods.length + ')';
            $('modalBody').innerHTML = html;
            showModal();
        }
        
        function removeModification(sku) {
            const mod = state.modifications[sku];
            const productName = mod ? (mod.product.color || '-') + ' T:' + (mod.product.talle || '-') : sku;
            
            if (!confirm('¬øEliminar modificaci√≥n de ' + productName + '?')) {
                return;
            }
            
            delete state.modifications[sku];
            saveModifications();
            render();
            
            // Actualizar modal si est√° abierto
            const modalOpen = $('modalOverlay').classList.contains('show');
            if (modalOpen) {
                const remainingMods = Object.values(state.modifications).length;
                if (remainingMods > 0) {
                    viewModifications();
                } else {
                    closeModal();
                    toast('Lista vac√≠a', 'warning');
                }
            } else {
                toast('‚úì Modificaci√≥n eliminada');
            }
        }
        
        function generateWhatsAppText() {
            const mods = Object.values(state.modifications);
            if (!mods.length) return '';
            
            const grouped = {};
            mods.forEach(mod => {
                const p = mod.product;
                const key = p.titulo || p.articulo || 'Sin nombre';
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(mod);
            });
            
            let text = 'üìä *AJUSTE DE STOCK*\n';
            text += new Date().toLocaleString('es-AR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            }).replace(',', '') + '\n';
            text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
            
            Object.keys(grouped).sort().forEach(article => {
                text += 'üîπ *' + article + '*\n';
                grouped[article].forEach(mod => {
                    const p = mod.product;
                    const change = mod.newStock - mod.oldStock;
                    const arrow = change > 0 ? '‚¨ÜÔ∏è' : change < 0 ? '‚¨áÔ∏è' : '‚û°Ô∏è';
                    text += '   ' + arrow + ' SKU: ' + p.codigo + '  ' + (p.color || '-') + ' ‚Ä¢ T:' + (p.talle || '-') + '   ' + mod.oldStock + ' ‚Üí *' + mod.newStock + '* (' + (change >= 0 ? '+' : '') + change + ')\n';
                });
            });
            
            text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            text += 'Total modificaciones: *' + mods.length + '*\n\n';
            
            text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            text += 'üìã *RESUMEN PARA EXCEL*\n';
            text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
            
            const sortedMods = [...mods].sort((a, b) => {
                const skuA = a.product.codigo || '';
                const skuB = b.product.codigo || '';
                return skuA.localeCompare(skuB);
            });
            
            sortedMods.forEach(mod => {
                const change = mod.newStock - mod.oldStock;
                text += mod.product.codigo + '\t' + change + '\n';
            });
            
            return text;
        }
        
        function fallbackCopy(text) {
            try {
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                ta.style.top = '-9999px';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                const ok = document.execCommand('copy');
                document.body.removeChild(ta);
                return ok;
            } catch(e) {
                return false;
            }
        }
        
        async function copyText(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(text);
                    return true;
                } catch(e) {
                    return fallbackCopy(text);
                }
            }
            return fallbackCopy(text);
        }
        
        function copyForWhatsApp() {
            const mods = Object.values(state.modifications);
            if (!mods.length) {
                toast('No hay modificaciones', 'warning');
                return;
            }
            
            const text = generateWhatsAppText();
            const preview = text.replace(/\*/g, '');
            
            // Intentar copiar, pero siempre mostrar el modal
            copyText(text).then(ok => {
                if (ok) toast('‚úì Copiado al portapapeles', 'success');
            });
            
            $('modalTitle').textContent = 'Preview WhatsApp';
            $('modalBody').innerHTML = 
                '<div class="whatsapp-preview">' + preview + '</div>' +
                '<div style="margin-top: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px; font-size: 0.75em; color: var(--text-secondary);">' +
                'üí° El resumen muestra la DIFERENCIA (cambio) separada por TAB - perfecto para pegar en Excel' +
                '</div>' +
                '<div style="display: flex; flex-direction: column; gap: 8px; margin-top: 16px;">' +
                '<button onclick="shareToWhatsApp()" style="width: 100%; background: #25D366; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1em;">üí¨ Enviar por WhatsApp</button>' +
                '<button onclick="copyText(generateWhatsAppText()).then(ok => { if(ok) toast(\'‚úì Copiado\', \'success\'); else toast(\'No se pudo copiar\', \'error\'); });" style="width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1em;">üìã Copiar texto</button>' +
                '</div>';
            showModal();
        }
        
        function shareToWhatsApp() {
            const text = generateWhatsAppText();
            if (!text) return;
            const encodedText = encodeURIComponent(text);
            const whatsappUrl = 'https://wa.me/?text=' + encodedText;
            window.open(whatsappUrl, '_blank');
        }
        
        function openSettings() {
            const isDark = state.theme === 'dark';
            const totalProducts = PRODUCTS.length;
            const zeroStock = PRODUCTS.filter(p => p.stock === 0).length;
            const lowStock = PRODUCTS.filter(p => p.stock > 0 && p.stock <= state.lowStockThreshold).length;
            const modCount = Object.keys(state.modifications).length;
            const lastSync = localStorage.getItem('mikra_lastSync');
            const syncAge = lastSync ? Math.floor((Date.now() - new Date(lastSync).getTime()) / 60000) : -1;
            const syncText = syncAge < 0 ? 'Nunca' : syncAge < 1 ? 'Reci√©n' : 'Hace ' + syncAge + ' min';
            
            $('modalTitle').textContent = '‚öôÔ∏è Configuraci√≥n';
            $('modalBody').innerHTML = 
                // COMPACT STATS BAR
                '<div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;">' +
                '<div style="flex:1;text-align:center;padding:8px 4px;background:var(--bg-input);border-radius:8px;border:1px solid var(--border);min-width:70px"><div style="font-weight:800;font-size:1.1em;color:var(--primary)">' + totalProducts.toLocaleString() + '</div><div style="font-size:0.6em;color:var(--text-secondary)">Total</div></div>' +
                '<div style="flex:1;text-align:center;padding:8px 4px;background:var(--bg-input);border-radius:8px;border:1px solid var(--border);min-width:70px"><div style="font-weight:800;font-size:1.1em;color:var(--danger)">' + zeroStock.toLocaleString() + '</div><div style="font-size:0.6em;color:var(--text-secondary)">Sin stock</div></div>' +
                '<div style="flex:1;text-align:center;padding:8px 4px;background:var(--bg-input);border-radius:8px;border:1px solid var(--border);min-width:70px"><div style="font-weight:800;font-size:1.1em;color:var(--warning)">' + lowStock + '</div><div style="font-size:0.6em;color:var(--text-secondary)">Bajo</div></div>' +
                '<div style="flex:1;text-align:center;padding:8px 4px;background:var(--bg-input);border-radius:8px;border:1px solid var(--border);min-width:70px"><div style="font-weight:800;font-size:1.1em;color:var(--purple)">' + modCount + '</div><div style="font-size:0.6em;color:var(--text-secondary)">Modif.</div></div>' +
                '</div>' +
                '<div style="text-align:center;font-size:0.68em;color:var(--text-secondary);margin-bottom:14px">üîÑ ' + syncText + '</div>' +
                
                // SETTINGS TABLE - everything in compact rows
                '<table style="width:100%;border-collapse:separate;border-spacing:0 2px;"><colgroup><col><col style="width:90px"></colgroup>' +
                '<tr><td style="padding:10px 0;font-size:0.85em;">üåô Modo oscuro</td><td style="text-align:right;padding:10px 0;"><label class="toggle"><input type="checkbox" id="setTheme" ' + (isDark ? 'checked' : '') + ' onchange="toggleTheme()"><span class="toggle-slider"></span></label></td></tr>' +
                '<tr><td style="padding:10px 0;font-size:0.85em;">üìê Modo compacto</td><td style="text-align:right;padding:10px 0;"><label class="toggle"><input type="checkbox" id="setCompact" ' + (state.compactMode ? 'checked' : '') + ' onchange="toggleCompact()"><span class="toggle-slider"></span></label></td></tr>' +
                '<tr><td style="padding:10px 0;font-size:0.85em;">üì∑ Im√°genes al iniciar</td><td style="text-align:right;padding:10px 0;"><label class="toggle"><input type="checkbox" id="setImages" ' + (state.defaultImages ? 'checked' : '') + ' onchange="toggleDefaultImages()"><span class="toggle-slider"></span></label></td></tr>' +
                '<tr><td style="padding:10px 0;font-size:0.85em;">‚ö†Ô∏è Umbral bajo stock</td><td style="text-align:right;padding:10px 0;"><input type="number" class="setting-number" id="setLowStock" value="' + state.lowStockThreshold + '" min="1" max="99"></td></tr>' +
                '<tr><td style="padding:10px 0;font-size:0.85em;">üìÑ Por p√°gina</td><td style="text-align:right;padding:10px 0;"><select class="setting-select" id="setPageSize">' +
                '<option value="25"' + (state.pageSize===25?' selected':'') + '>25</option>' +
                '<option value="50"' + (state.pageSize===50?' selected':'') + '>50</option>' +
                '<option value="100"' + (state.pageSize===100?' selected':'') + '>100</option>' +
                '<option value="200"' + (state.pageSize===200?' selected':'') + '>200</option>' +
                '</select></td></tr>' +
                '<tr><td style="padding:10px 0;font-size:0.85em;">üè∑Ô∏è Mostrar SKU/Ubic.</td><td style="text-align:right;padding:10px 0;"><label class="toggle"><input type="checkbox" id="setShowSku" ' + (state.showSku ? 'checked' : '') + ' onchange="state.showSku=this.checked"><span class="toggle-slider"></span></label></td></tr>' +
                '<tr><td style="padding:10px 0;font-size:0.85em;">üîÑ Auto-sync</td><td style="text-align:right;padding:10px 0;"><select class="setting-select" id="setAutoSync">' +
                '<option value="0"' + (state.autoSyncMin===0?' selected':'') + '>Off</option>' +
                '<option value="5"' + (state.autoSyncMin===5?' selected':'') + '>5 min</option>' +
                '<option value="10"' + (state.autoSyncMin===10?' selected':'') + '>10 min</option>' +
                '<option value="15"' + (state.autoSyncMin===15?' selected':'') + '>15 min</option>' +
                '<option value="30"' + (state.autoSyncMin===30?' selected':'') + '>30 min</option>' +
                '</select></td></tr>' +
                '</table>' +
                
                // COMPACT ACTIONS
                '<div style="display:flex;gap:6px;margin-top:14px;">' +
                '<button onclick="exportModsCSV()" style="flex:1;background:var(--success);color:#1a2744;border:none;padding:10px;border-radius:8px;font-weight:700;font-size:0.8em;cursor:pointer;">üì§ CSV</button>' +
                '<button onclick="forceSync()" style="flex:1;background:var(--primary);color:white;border:none;padding:10px;border-radius:8px;font-weight:700;font-size:0.8em;cursor:pointer;">üîÑ Sync</button>' +
                '<button onclick="clearCache()" style="flex:1;background:var(--danger);color:white;border:none;padding:10px;border-radius:8px;font-weight:700;font-size:0.8em;cursor:pointer;opacity:0.8;">üóëÔ∏è Cach√©</button>' +
                '</div>' +
                
                // SAVE
                '<button onclick="saveAllSettings()" style="width:100%;background:var(--primary);color:white;border:none;padding:12px;border-radius:10px;font-weight:700;font-size:0.95em;cursor:pointer;margin-top:10px;">‚úì Guardar</button>';
            
            showModal();
        }
        
        function toggleTheme() {
            state.theme = $('setTheme').checked ? 'dark' : 'light';
            applyTheme();
        }
        
        function applyTheme() {
            if (state.theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                document.querySelector('meta[name="theme-color"]').content = '#ffffff';
            } else {
                document.documentElement.removeAttribute('data-theme');
                document.querySelector('meta[name="theme-color"]').content = '#1a2744';
            }
        }
        
        function toggleCompact() {
            state.compactMode = $('setCompact').checked;
            document.body.classList.toggle('compact', state.compactMode);
        }
        
        function toggleDefaultImages() {
            state.defaultImages = $('setImages').checked;
        }
        
        function saveAllSettings() {
            // Read values from form
            const lowStock = parseInt($('setLowStock').value);
            if (isNaN(lowStock) || lowStock < 1) { toast('‚ö†Ô∏è Umbral debe ser ‚â• 1', 'warning'); return; }
            
            state.lowStockThreshold = lowStock;
            state.pageSize = parseInt($('setPageSize').value);
            state.autoSyncMin = parseInt($('setAutoSync').value);
            
            // Persist
            try {
                localStorage.setItem('mikra_settings', JSON.stringify({
                    lowStockThreshold: state.lowStockThreshold,
                    pageSize: state.pageSize,
                    autoSyncMin: state.autoSyncMin,
                    theme: state.theme,
                    compactMode: state.compactMode,
                    defaultImages: state.defaultImages || false,
                    showSku: state.showSku || false
                }));
            } catch(e) {}
            
            // Restart auto-sync with new interval
            setupAutoSync();
            
            closeModal();
            state.page = 1;
            applyFilters();
            toast('‚úì Configuraci√≥n guardada', 'success');
        }
        
        function exportModsCSV() {
            const mods = Object.values(state.modifications);
            if (!mods.length) { toast('No hay modificaciones', 'warning'); return; }
            
            let csv = 'SKU,Art√≠culo,Color,Talle,Ubicaci√≥n,Stock Anterior,Stock Nuevo,Diferencia\n';
            mods.forEach(m => {
                const p = m.product;
                csv += [p.codigo, (p.titulo||p.articulo||'').replace(/,/g,';'), p.color||'-', p.talle||'-', p.ubicacion||'-', m.oldStock, m.newStock, m.newStock - m.oldStock].join(',') + '\n';
            });
            
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'mikra_modificaciones_' + new Date().toISOString().slice(0,10) + '.csv';
            a.click();
            toast('‚úì CSV descargado', 'success');
        }
        
        function forceSync() {
            closeModal();
            loadData(false);
        }
        
        function clearCache() {
            if (!confirm('‚ö†Ô∏è ¬øBorrar cach√© de productos? (Las modificaciones se mantienen)')) return;
            localStorage.removeItem('mikra_products');
            localStorage.removeItem('mikra_images');
            localStorage.removeItem('mikra_lastSync');
            closeModal();
            toast('‚úì Cach√© borrada ‚Äî sincronizando...', 'success');
            loadData(false);
        }
        
        function clearModifications() {
            if (!Object.keys(state.modifications).length) {
                toast('No hay modificaciones', 'warning');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è ¬øBorrar todas las modificaciones?')) {
                return;
            }
            
            state.modifications = {};
            saveModifications();
            render();
            toast('‚úì Modificaciones borradas', 'success');
        }
        
        function closeModal(event) {
            if (event && event.target !== $('modalOverlay')) return;
            $('modalOverlay').classList.remove('show');
            document.body.classList.remove('modal-open');
        }
        function showModal() {
            $('modalOverlay').classList.add('show');
            document.body.classList.add('modal-open');
        }
        
        function toast(msg, type = '') {
            const t = $('toast'); 
            t.textContent = msg; 
            t.className = 'toast show';
            if (type) t.classList.add(type);
            setTimeout(() => t.className = 'toast', 1500);
        }
        
        // === PRE-COMPUTED SEARCH INDEX ===
        // Avoid calling .toLowerCase() thousands of times per filter
        let SEARCH_INDEX = []; // [{id, searchText, ...product}]
        
        function buildSearchIndex() {
            SEARCH_INDEX = PRODUCTS.map(p => ({
                ...p,
                _search: [p.codigo, p.titulo, p.articulo, p.color, p.ubicacion]
                    .filter(Boolean).join(' ').toLowerCase(),
                _titulo: (p.titulo || '').toLowerCase(),
                _articulo: (p.articulo || '').toLowerCase(),
                _color: (p.color || '').toLowerCase(),
                _ubicacion: (p.ubicacion || '').toLowerCase()
            }));
        }
        
        // === CACHE-FIRST LOADING ===
        // Show cached data INSTANTLY, then sync in background
        
        const CACHE_MAX_AGE_MS = 5 * 60 * 1000; // 5 minutes ‚Äî skip API if cache is fresh
        
        function loadFromCache() {
            try {
                const cached = localStorage.getItem('mikra_products');
                if (!cached) return false;
                PRODUCTS = JSON.parse(cached);
                loadImagesFromCache();
                buildSearchIndex();
                updateUniqueArticles();
                applyFilters();
                
                const lastSync = localStorage.getItem('mikra_lastSync');
                if (lastSync) {
                    const ago = Date.now() - new Date(lastSync).getTime();
                    const mins = Math.floor(ago / 60000);
                    $('syncTime').textContent = mins < 1 ? '‚Ä¢ Reciente' : '‚Ä¢ Hace ' + mins + ' min';
                } else {
                    $('syncTime').textContent = '‚Ä¢ Cach√©';
                }
                return true;
            } catch(e) { return false; }
        }
        
        function isCacheFresh() {
            try {
                const lastSync = localStorage.getItem('mikra_lastSync');
                if (!lastSync) return false;
                return (Date.now() - new Date(lastSync).getTime()) < CACHE_MAX_AGE_MS;
            } catch(e) { return false; }
        }
        
        async function syncFromAPI(isBackground) {
            $('syncDot').classList.add('loading');
            $('syncDot').classList.remove('error');
            document.querySelector('.header-bar').classList.remove('error');
            $('syncStatus').textContent = 'Sincronizando...';
            
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000);
            
            try {
                const response = await fetch(API_URL, { signal: controller.signal });
                clearTimeout(timeout);
                const data = await response.json();
                
                if (data.success && data.products && data.products.length > 0) {
                    PRODUCTS = data.products;
                    
                    if (data.images) {
                        IMAGES_MAP = data.images;
                        localStorage.setItem('mikra_images', JSON.stringify(IMAGES_MAP));
                    }
                    
                    localStorage.setItem('mikra_products', JSON.stringify(PRODUCTS));
                    localStorage.setItem('mikra_lastSync', new Date().toISOString());
                    
                    buildSearchIndex();
                    reconcileModifications(); // #15 sync mods with fresh data
                    updateUniqueArticles();
                    applyFilters();
                    
                    $('syncDot').classList.remove('loading', 'error');
                    $('syncStatus').textContent = 'Sincronizado';
                    $('syncTime').textContent = '‚Ä¢ ' + new Date().toLocaleTimeString();
                    $('loadingScreen').classList.add('hidden');
                    
                    if (isBackground) toast('‚úì Actualizado', 'success');
                    else toast('‚úì ' + data.count + ' productos');
                } else { throw new Error('No products'); }
            } catch (error) {
                clearTimeout(timeout);
                $('syncDot').classList.remove('loading');
                $('syncDot').classList.add('error');
                document.querySelector('.header-bar').classList.add('error');
                $('syncStatus').textContent = 'Error';
                
                // If no cache was loaded before, try now
                if (!PRODUCTS.length) {
                    const cached = localStorage.getItem('mikra_products');
                    if (cached) {
                        PRODUCTS = JSON.parse(cached);
                        loadImagesFromCache();
                        buildSearchIndex();
                        updateUniqueArticles();
                        applyFilters();
                        $('loadingScreen').classList.add('hidden');
                        $('syncTime').textContent = '‚Ä¢ Cach√©';
                        toast('‚ö†Ô∏è Usando cach√©', 'warning');
                    } else {
                        $('loadingText').textContent = '‚ùå Error de conexi√≥n';
                        $('loadingError').style.display = 'block';
                    }
                } else {
                    // Already showing cache, just warn
                    if (isBackground) toast('‚ö†Ô∏è No se pudo sincronizar', 'warning');
                }
            }
        }
        
        // Main entry point
        async function loadData(forceSync) {
            // Step 1: Try cache first (instant)
            const hasCache = loadFromCache();
            
            if (hasCache) {
                // Hide loading screen immediately
                $('loadingScreen').classList.add('hidden');
                $('syncDot').classList.remove('loading', 'error');
                $('syncStatus').textContent = 'Cach√©';
                
                // Step 2: If cache is fresh enough, skip API
                if (!forceSync && isCacheFresh()) {
                    $('syncStatus').textContent = 'Listo';
                    return;
                }
                
                // Step 3: Sync in background (user already sees data)
                syncFromAPI(true);
            } else {
                // No cache ‚Äî must wait for API (show loading screen)
                $('loadingText').textContent = 'Cargando inventario...';
                $('loadingError').style.display = 'none';
                syncFromAPI(false);
            }
        }
        
        // Event Listeners
        
        // Debounce utility - prevents firing on every keystroke
        function debounce(fn, ms) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), ms);
            };
        }
        
        const debouncedFilter = debounce(() => {
            showAutocomplete(state.search);
            applyFilters();
        }, 150);
        
        $('searchInput').addEventListener('input', e => {
            state.search = e.target.value.trim(); state.searchExact = false; state.colors = []; state.sizes = [];
            $('searchClear').classList.toggle('show', state.search.length > 0);
            debouncedFilter();
        });
        
        $('searchInput').addEventListener('focus', () => { if (state.search.length >= 2) showAutocomplete(state.search); });
        
        $('autocomplete').addEventListener('click', e => {
            const item = e.target.closest('.autocomplete-item');
            if (item) {
                const name = item.dataset.name;
                $('searchInput').value = name; state.search = name; state.searchExact = true;
                forceListView = false;
                $('searchClear').classList.add('show'); $('autocomplete').classList.remove('show'); applyFilters();
            }
        });
        
        document.addEventListener('click', e => { if (!e.target.closest('.search-container')) $('autocomplete').classList.remove('show'); });
        
        document.querySelectorAll('[data-stock]').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('[data-stock]').forEach(e => e.classList.remove('active'));
                el.classList.add('active'); state.stock = el.dataset.stock; applyFilters();
            });
        });
        
        // Colores: single por defecto, multi con toggle
        $('colorOptions').addEventListener('click', e => {
            const opt = e.target.closest('[data-color]'); if (!opt) return;
            const color = opt.dataset.color;
            if (color === '') {
                state.colors = [];
            } else if (state.multiSelect) {
                const idx = state.colors.indexOf(color);
                if (idx > -1) state.colors.splice(idx, 1);
                else state.colors.push(color);
            } else {
                state.colors = state.colors.length === 1 && state.colors[0] === color ? [] : [color];
            }
            applyFilters();
        });
        
        // Talles: siempre single select
        $('sizeOptions').addEventListener('click', e => {
            const opt = e.target.closest('[data-size]'); if (!opt) return;
            const size = opt.dataset.size;
            if (size === '') {
                state.sizes = [];
            } else {
                state.sizes = state.sizes.length === 1 && state.sizes[0] === size ? [] : [size];
            }
            applyFilters();
        });
        
        // #3 Load persisted settings
        function loadSettings() {
            try {
                const saved = JSON.parse(localStorage.getItem('mikra_settings') || '{}');
                if (saved.lowStockThreshold) state.lowStockThreshold = saved.lowStockThreshold;
                if (saved.pageSize) state.pageSize = saved.pageSize;
                if (saved.autoSyncMin !== undefined) state.autoSyncMin = saved.autoSyncMin;
                if (saved.theme) state.theme = saved.theme;
                if (saved.compactMode) state.compactMode = saved.compactMode;
                if (saved.defaultImages) { state.defaultImages = true; state.showImages = true; }
                if (saved.showSku) state.showSku = true;
            } catch(e) {}
            
            // Apply theme immediately
            applyTheme();
            document.body.classList.toggle('compact', state.compactMode);
            if (state.showImages) {
                $('photosBtn').classList.add('active');
                $('productList').classList.add('show-images');
            }
        }
        
        let autoSyncTimer = null;
        function setupAutoSync() {
            if (autoSyncTimer) clearInterval(autoSyncTimer);
            if (state.autoSyncMin > 0) {
                autoSyncTimer = setInterval(() => {
                    if (document.visibilityState === 'visible' && navigator.onLine) {
                        syncFromAPI(true);
                    }
                }, state.autoSyncMin * 60 * 1000);
            }
        }
        
        // #15 Reconcile modifications after sync ‚Äî update product refs, drop stale mods
        function reconcileModifications() {
            const newMods = {};
            Object.entries(state.modifications).forEach(([sku, mod]) => {
                const freshProduct = PRODUCTS.find(p => p.codigo === sku);
                if (freshProduct) {
                    if (freshProduct.stock === mod.newStock) return; // server caught up
                    newMods[sku] = {
                        oldStock: freshProduct.stock,
                        newStock: mod.newStock,
                        product: freshProduct
                    };
                }
            });
            state.modifications = newMods;
            saveModifications();
        }
        
        // #9 Offline/online detection
        window.addEventListener('online', () => {
            $('offlineBar').classList.remove('show');
            toast('‚úì Conectado', 'success');
            syncFromAPI(true);
        });
        window.addEventListener('offline', () => {
            $('offlineBar').classList.add('show');
        });
        
        // Inicializar
        loadSettings();
        loadModifications();
        loadImagesFromCache();
        if (!navigator.onLine) $('offlineBar').classList.add('show');
        loadData(); // Cache-first: shows cached data instantly, syncs in background
        setTimeout(loadImagesFromAPI, 2000); // Delay image API to prioritize product data
        
        // Auto-sync with configurable interval
        setupAutoSync();
    </script>
    <script>
    // Service Worker ‚Äî usa sw.js externo
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => {
                console.log('‚úÖ SW registrado');
                // Check for updates periodically
                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'activated') {
                            console.log('üîÑ SW actualizado');
                        }
                    });
                });
            })
            .catch(err => console.log('SW error:', err));
    }
    </script>
</body>
</html>
